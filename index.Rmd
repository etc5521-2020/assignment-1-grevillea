---
title: "ETC5521 Assignment 2"
subtitle: "Tour de france"
team: Grevillea
author:
  - (Samuel Lyubic)
  - (Brendi Ang)
  - Dewi Lestari Amaliah
  - Yiwen Jiang
date: "`r Sys.Date()`"
output:
    bookdown::html_document2:
      keep_tex: yes
      number_sections: yes
      citation_package: biblatex
      toc: true
bibliography: references.bib
biblio-style: authoryear-comp
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.align = 'center')

# load libraries
library(tidyverse)
library(kableExtra)
library(lubridate)
library(tdf)
library(plotly)
library(ggExtra)
library(ggforce)
library(patchwork)
# For web scraping
library(polite)
library(rvest)
library(ggrepel)
library(naniar)
library(gganimate)
```

[This assignment is for ETC5521 Assignment 1 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}

# Introduction

The Tour de France is a cycling tournament that is held in France annually which spans across 21 stages over 23 gruelling days. It is considered one of the most prestigious races that elite cyclists can partake in given the level of diffiulty of riding through the ranging beautiful French landscapes (EEB (2020)).  Despite being an individual event, riders travel through the whole country in teams of 8 in order to strategically position the team leader in the best position to win the general classfications. This report mainly analyses the changes in the Tour de France over the past hundred years and the changes in riders’ characteristics. Our statistical programming used for analysis is _R_ and _Rstudio_.

## Motivation

Tour De France (“Le Tour”) is an annual men’s bicycle race that in modern days encompasses a 21-day course that covers approximately 3,500km. It is predominantly held in France while often passing through other countries.  (Encyclopedia Britannica (2020)). The teams would pass through long countryside roads, steep alpine regions and tight city areas, covering terrain ranging from rolling hills, long ﬂat grounds and steep mountainous. The types of terrain dispersed across the diﬀerent stages over the 23 days. The rider that completes the most stages in the shortest amount of time wins the overall title.

Due to the long duration of the race, the intelligence or athletic ability of the riders are not the only factors in winning the race. The key to winning the competition also lies in the choice of strategy. Besides, with technological changes in the past hundred years and people's living standards have improved, various changes have taken place in the Tour de France. We will present our findings of the Tour de France through the exploration of the recording data from 1903 to 2019.


## Data Source

The original source of the Tour de France data set is from the `tdf` package written by @tdf. The data is then provided and available to download in the [TidyTuesday's GitHub repository](https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-04-07/readme.md) by @jthomasmock. There are three data sets regarding Tour de France available in this repository, namely `tdf_winners.csv`, `stage_data.csv`, and `tdf_stages.csv`. These data sets only covered the time period up to 2017, so we got the data from 2018 and 2019 year from Wikipedia [@wikiTDF2018] and [@wikiTDF2019].

```{r read-data, include = FALSE}
stage_clean <- read.csv(here::here("data/stage_data.csv"))
winners <- read.csv(here::here("data/tdf_winners.csv"))
tdf_stages <- read.csv(here::here("data/tdf_stages.csv"))
```

## Data Limitation

```{r, fig.cap="Visualise the missing value in winner data", fig.align= "center"}
winners %>%
  vis_miss(sort_miss = TRUE)
```

- 
-	There are many factors that affect the rider's race performance, such as the weather conditions on the day of the race, and the rider's psychological factors. We cannot analysis all the aspects that affects the outcome of the competition.  
-	The dataset contains too much variables, there are relatively low proportion of missing values, so there are many analyisable questions. That it is difficult to cover all the possible analysis in one report.  
-	The time frame in the dataset are not consistent. `tdf_stages` data inside `tdf` package only provided data till the 2017 year while the other two data are covered all the way to 2019. Therefore, when using this data for analysis, we must consider whether to discard the data after 2017 or get the data from outher source like Wikipedia. If the analysis is for prediction, the data in recent years is the relatively important, and it is unreasonable to discard the data in recent years. However, when we choose to complete the data after 2017, it is necessary to ensure the consistency of the data, such as the method to record the data may be various between different institutions.  


# Data Description


The data set records competition information of Tour de France, published on Alastair Rushworth’s [Github](https://github.com/alastairrushworth/tdf). The data recorded the competition information since the first organized in 1903, and 106 competitions been hold since then.

The Tour de France is a men's multi-stage cycling race held annually in France and nearby countries. It was established in 1903 to increase the sales of the newspaper L'Auto. This event has become an important cultural event for European fans.

This dataset includes the information of 106 winners, stages of each competition and the riders’ information of each stage in the competition. The time frame of the data recording was started in 1903 and until 2019. Alastair Rushworth collected the recording information from various websites and other places and then integrates it into the dataset. The dataset was separated into three data files and provided by .csv format. The following are the variables in each data.

- The `tdf_winner` data comes from _tdf_winners.csv_. The data contains information about 106 winners of the Tour de France from 1903 to 2019. The part of the variables are showing in the Table \@ref(tab:winners-table).  

```{r winners-table, echo=FALSE}
winners_info <- tibble(Variable = c("edition", "start_date", "winner_name", "winner_team", "distance", 
                                    "time_overall", "time_margin", "height", "weight", 
                                    "age", "nationality"),
                          Class = c("integer", "double", "character", "character", "double", "double", "double", 
                                    "double", "double", "integer", "character"),
                          Description = c("Edition of the Tour de France", "Start date of the Tour", 
                                          "Winner's name", 
                                          "Winner's team (NA if not on a team)", 
                                          "Distance traveled in KM across the entire race", 
                                          "Time in hours taken by the winner to complete the race",
                                          "Difference in finishing time between the race winner and the runner up",
                                          "Height in meters",
                                          "Weight in kg",
                                          "Age as winner",
                                          "Nationality")) 

winners_info %>%
  kable(booktabs = TRUE,
        caption = "Variables in tdf_winners data") %>%
  kable_styling(bootstrap_options =  c("striped", "hover", "condensed", "responsive"), 
                full_width = F, 
                position = "center")
```

- The `stage_data` data comes from _stage_data.csv_. The data contains ranking information for each stage of the annual race. The variables are showing in the Table \@ref(tab:stage-clean-table). 

```{r stage-clean-table, echo=FALSE}
stage_data_info <- tibble(Variable = c("edition", "year", "stage_results_id", "rank", "time", "rider", "age", 
                                       "team", "points", "elapsed", "bib_number"),
                          Class = c("integer", "double", "character", "character", "double", "character", "integer",
                                    "character", "integer", "double", "integer"),
                          Description = c("Race edition", 
                                          "Year of race", 
                                          "Stage ID", 
                                          "Rank of racer for stage", 
                                          "Time of racer",
                                          "Rider name",
                                          "Age of racer",
                                          "Team (NA if not on team)",
                                          "Points for the stage",
                                          "Time elapsed stored as lubridate::period",
                                          "Bib number")) 

stage_data_info %>%
  kable(booktabs = TRUE,
        caption = "Variables in stage_data data") %>%
  kable_styling(bootstrap_options =  c("striped", "hover", "condensed", "responsive"), 
                full_width = F, 
                position = "center")
```

- The `stage_data` data comes from _stage_data.csv_. The data contains information of each stage for the annual race. The variables are showing in the Table \@ref(tab:stage-table). 

```{r stage-table, echo=FALSE}
stage_info <- tibble(Variable = c("Stage", "Date", "Distance", "Origin", "Destination", "Type", "Winner", "Winner_Country"),
                          Class = c("character", "double", "double", "character", "character", "character", "character", "character"),
                          Description = c("Stage Number", 
                                          "Date of stage", 
                                          "Distance in KM", 
                                          "Origin city", 
                                          "Destination city",
                                          "Stage Type",
                                          "Winner of the stage",
                                          "Winner's nationality")) 

stage_info %>%
  kable(booktabs = TRUE,
        caption = "Variables in tdf_stages data") %>%
  kable_styling(bootstrap_options =  c("striped", "hover", "condensed", "responsive"), 
                full_width = F, 
                position = "center")
```

## Relevant Questions

The dataset is primarily used to analysis the changes on the Tour de France over hundred years. The primary question to answer from this dataset is how the performance of those riders is. After an overview of the primary question, we will conduct more specific analysis through the secondary questions as showing below:

1. What are the characteristics of Tour de France winner riders? 
2. How does the distance and speed of the Tour de France change?
3. Is the Tour de France becoming more competitive?


## Data cleaning processes

The dataset has used come from the Alastair Rushworth's Data Package `tdf` package. The dataset contains information about the overall winning rider for each edition of the race. The winner's biographical information and the results for each stage in each edition. To install the package, use ` install_github("alastairrushworth/tdf")`.  
-	The `winner` data can be imported from `editions` in the `tdf` package, we only need to filter out the `stage_results` variable.  
-	The `stage_data` dataset is also import by `tdf::editions`, the stage information are been nested on the `stage_results` variable. We use the unnest_longer() function to a rectangle the nested `stage` data into a tidy tibble, and then use the flatten_df() function to flatten a list of lists into a simple vector. This process is essential because `stage` data were nested in the `editions` data, we cannot read `stage` data directly from `editions` data. Finally, select the relevant variables and use the `year()` function in the `lubridate` package to extract the year of each race.   
-	It is the most convenient way to directly read the `tdf_stages` data from the `tdf` package, but it only provided data till the 2017 year while the actual dataset covered all the way to 2019. Thus, we opted to use the cleaning script found in the [GitHub](https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-04-07/readme.md).  Furthermore, our debugging process includes renaming inconsistent variable names, extracting components of date-time objects and using regular expressions to fix the structure of character strings to reproduce the same data set that was intended. In addition, we web scraped the data from Wikipedia (@wikiTDF2018 and @wikiTDF2019) to obtain the stages data set for 2018 and 2019. These Wiki pages correspond to how the actual data set obtained its data; Thus, binding the data was straightforward as the structure the data was analogous with the `tdf_stages` data set.    

<details><summary>Expand here to see part of the data cleaning codes </summary>  

```{r, eval=FALSE, echo=TRUE}
library(tidyverse)
library(tdf) # install at: https://github.com/alastairrushworth/tdf

winners <- tdf::editions %>% 
  select(-stage_results)

all_years <- tdf::editions %>% 
  unnest_longer(stage_results) %>% 
  mutate(stage_results = map(stage_results, ~ mutate(.x, rank = as.character(rank)))) %>% 
  unnest_longer(stage_results) 

stage_all <- all_years %>% 
  select(stage_results) %>% 
  flatten_df()

combo_df <- bind_cols(all_years, stage_all) %>% 
  select(-stage_results)

stage_clean <- combo_df %>% 
  select(edition, start_date,stage_results_id:last_col()) %>% 
  mutate(year = lubridate::year(start_date)) %>% 
  rename(age = age...25) %>% 
  select(edition, year, everything(), -start_date)

winners %>% 
  write_csv(here::here("2020", "2020-04-07", "tdf_winners.csv"))

stage_clean %>% 
  write_csv(here::here("2020", "2020-04-07", "stage_data.csv"))

```

</details>



# Analysis and findings

By overview of the Tour de France competition, first we begain to go through the performance of these winners and also the riders. We use the `winners` data to visualise how many times the riders have won the competition and use the `stage_clean` data to see how they perform on each of the stage in the competition.

```{r, fig.cap="The number of times the rider win the Tour de France"}
winners %>%
  count(winner_name, sort = TRUE) %>%
  filter(n > 1) %>%
  ggplot(aes(reorder(winner_name, n), n)) +
  geom_col(width = 0.8,
           alpha = 0.8,
           color = "#85929E",
           fill = "#85929E") +
  labs(x = NULL, y = NULL) +
  geom_text(aes(label = n, y = n + 0.5)) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        panel.background = element_blank()) +
  coord_flip()
```

Refer to Figure 1, it presents the rank of number ot times the rider won the Tour de France in history. Lance Armstrong has won the competition seven total times, which is higher than most of the riders.  This brings us to an interesting question, does the winner achieve high rank or extraordinary performance in most of the stages?

```{r}
tdf_stages_animation <- tdf_stages %>%
  mutate(year = year(Date),
         stage = Stage)

stages_joined <- stage_clean %>%
  extract(stage_results_id, "stage", "stage-(.*)") %>%
  inner_join(tdf_stages_animation, by = c("year", "stage")) %>%
  mutate(rank = as.integer(rank)) %>%
  group_by(year, stage) %>%
  mutate(finishers = sum(!is.na(rank))) %>%
  ungroup() %>%
  mutate(percentile = 1 - rank / finishers)

total_points <- stages_joined %>%
  group_by(year, rider) %>%
  summarise(total_points = sum(points, na.rm = TRUE)) %>%
  mutate(point_rank = percent_rank(total_points)) %>%
  ungroup()

top_10_2019 <- total_points %>%
  filter(year == max(year)) %>%
  top_n(15, total_points)
```

```{r, fig.cap="The number of times the rider win the Tour de France"}
stages_joined %>%
  filter(year == max(year)) %>%
  semi_join(top_10_2019, by = "rider") %>%
  mutate(stage = as.integer(stage),
         points = coalesce(points, 0)) %>%
  arrange(stage) %>%
  group_by(rider) %>%
  mutate(cumulatice_points = cumsum(points)) %>%
  ungroup() %>%
  mutate(highlight = ifelse(rider == "Bernal Egan", T, F)) %>%
  ggplot(aes(cumulatice_points, rider, fill = highlight)) +
  geom_col() +
  ylab("Riders") +
  xlab("Cumulative Points") +
  theme_classic() +
  theme(legend.position = "none") +
  scale_fill_manual(values=c('#839192', '#EC7063')) +
  transition_time(stage) 
```


The animation displays the changes in the cumulative points of riders in 2019 (the higher rank the higher points), It only shows the top 15 drivers with accumulated points. The red bar is the winner of 2019, Bernal Egan. It is not difficult to find that the winner does not need to achieve very good results at every stage. Compared with the riders who got the higher cumulative ponits, the winners’ cumulative ponits are only half of theirs. 

These figures give us a more in-depth exploration of data guidance. What are the characteristics of Tour de France winner riders? How does the distance and speed of the Tour de France change? Is the Tour de France becoming more competitive?

## What are the characteristics of those winner riders?

For sports, the physical fitness of an athlete is the core factor that affects the outcome of the game. Especially for races like the Tour de France, the 23-day race is a severe test for athletes' physical fitness.

BMI is usually an effective indicator for determining a person’s physical health. For example, a low BMI implies that the person will suffer and experienced weakened immune systems and/or weakened bones. We combine the height and weight variables of athletes into BMI according to the following formula:

<center>
$BMI = \frac{Weight(kg)}{(Height(m))^2}$

</center>

```{r bmi, fig.cap="BMI of previous Tour de France winners"}

editions %>%
  ggplot(aes(x = start_date, y = weight / height^2)) +
  geom_point(na.rm = TRUE) + 
  geom_hline(yintercept = c(19, 25), color = "red", linetype = "dashed") +
  geom_label_repel(data = editions %>% sample_n(20), 
                  aes(label = winner_name), size = 1.8,  
                  nudge_y = 4, na.rm = TRUE,
                  segment.alpha = 0.2) + 
  xlab('Edition date') + 
  ylab('Body mass index (BMI)') + 
  ggtitle('Tour de France winners BMI') + 
  theme_classic() 
```

Figure 1 shows the BMI value of the winners of the Tour de France in each year. We can observe that the BMI of the winners is mostly concentrated in a certain range. The red dash line is representing the range of appropriate BMI for adult males, which is between 19 and 25. In recent years, the BMI of the winners of the Tour de France has a certain downward trend, but this trend is not very obvious.

```{r age, fig.width=10, fig.cap="The age of the previous winners of the Tour de France"}
library(gridExtra)
age_line <- winners %>%
  group_by(decade = 10 * (year(start_date) %/% 10)) %>%
  summarise(age = mean(age, na.rm = TRUE)) %>%
  ggplot(aes(x = decade, y = age)) +
  geom_line(colour="steelblue") +
  ylab("Average Age") +
  xlab("Year") +
  ggtitle('Tour de France winers average age (per decade)') + 
  theme_classic() 

age_histogram <- winners %>%
  ggplot(aes(x = age)) +
  geom_histogram(binwidth = 2, colour="steelblue", fill="steelblue", alpha=0.2) +
  geom_vline(xintercept = mean(winners$age, na.rm = TRUE), color = "red", linetype = "dashed") +
  ylab("Count") +
  xlab("Winners' Age")+
  ggtitle('Tour de France winners age distribution') + 
  theme_classic() 

grid.arrange(age_line, age_histogram, ncol = 2)
```

Age often plays a big factor in the assessment of an athlete potential performance. The plots are present in Figure 2. The left panel display the trend of the average age of the winners (average over a decade). We can see that although the average age has a high volatile over the hundred years, if we focus on the trend after 1980 the average age of the winners has gradually increased, and the average age of those winners has achieved 29 in the past ten years. The right panel shows the age distribution of all winners. We can roughly see that the age distribution of the winners is mainly between 20 and 35 years old, and the average is about 27 years old. Compared to other competitions, the winners of the Tour de France are relatively older.

```{r, fig.cap="The number of times the Tour de France country has won"}
winners %>%
  count(nationality, sort = TRUE) %>%
  ggplot(aes(reorder(nationality, n), n)) +
  geom_col(width = 0.8,
           alpha = 0.8,
           color = "#E59866",
           fill = "#E59866") +
  labs(x = NULL, y = 'Tour de France wins') +
  geom_text(aes(label = n, y = n + 1)) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        panel.background = element_blank()) +
  coord_flip()
```

```{r, fig.cap="The number of times the Tour de France team has won"}
winners %>%
  count(winner_team, name = 'num_of_wins') %>%
  filter(num_of_wins > 1) %>%
  ggplot(aes(reorder(winner_team, num_of_wins), num_of_wins)) +
  geom_col(width = 0.8,
           alpha = 0.7,
           color = "#3498DB",
           fill = "#3498DB") +
  labs(x = NULL, y = 'Tour de France wins') +
  geom_text(aes(label = num_of_wins, y = num_of_wins + 0.5)) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        panel.background = element_blank()) +
  coord_flip()
```

If we compare the number of winners between countries (Refer to Figure 3), the number of France far exceeds the number of second place Belgium. Figure 4 compares the number of winners between the teams. The French team has four more winners than Alcyon-Dunlop which is ranked second. 

It is not difficult to observe that both the number of winners between countries and teams, the number of ranked first are much higher than the following. This is because the Tour de France also focuses on the strategy of the competition. A good team or country has a better strategy that is more suitable for the comprtition. Specifically, the financial backing of these larger teams allow them to attract top tier riders, coaches and staff given the pay packets they are able to provide as well as being able to afford all the the state of the art practices that assist performance thus potentially improving their dominance relative to smaller teams ((“What Makes Ineos Unbeatable?” 2019)). This may indicate that a rider may have a better chance of winning the Tour de France depending on the team they choose/are chosen for.


##  How does the distance and speed of the Tour de France change?

```{r combining-stage-clean-tdf-stage-data}
#code used to create the datasets for finding the terrains that aren't being completed as well as the overall winner

stage_clean_stg_number <- stage_clean %>%
  filter(year >= "1969") %>%
  group_by(stage_results_id) %>%
  separate(stage_results_id, c("stage", "stage_number"), "-") %>%
  mutate(year_stage = paste0(year, "-", stage_number)) 

tdf_stage_stg_number <- tdf_stages %>%
  mutate(year = year(Date),
         year_stage = paste0(year, "-", Stage)) %>%
  filter(year >= "1969") %>%
  select(Stage, Date, Type, year, year_stage, Distance) %>%
  janitor::clean_names() 

tdf_stage_clean <-  tdf_stage_stg_number %>%
  left_join(stage_clean_stg_number, by = "year_stage") %>%
  select(stage_number, rank, rider, elapsed, year.x, distance, type, date) %>%
  rename(year = year.x)

tdf_stages_names_clean <- tdf_stage_clean %>%
  mutate(
    Type_terrain = case_when(
      str_detect(type, "mountain|Mountain|mountain(s)") ~ "Mountain",
      str_detect(type, "Flat|Plain") ~ "Flat",
      str_detect(type, "Individual time trial|Mountain time trial") ~ "Time Trial",
      str_detect(type, "Hilly") ~ "Hilly Stage"))
```



```{r finding-pct-rider-DNF}
#Table showing the percentage of DNF OTL NQ by terrain
terrain_DNF_OTL_NQ <- tdf_stages_names_clean %>%
  filter(rank %in% c("DNF", "OTL", "NQ")) %>%
  group_by(Type_terrain) %>%
  summarise(not_finished = n()) %>%
  arrange(not_finished) %>%
  mutate(not_finished = as.numeric(not_finished))
  
total_riders_stage <- tdf_stages_names_clean %>%
  group_by(Type_terrain) %>%
  summarise(total_riders = n())

total_riders_dnf_terrain <- left_join(terrain_DNF_OTL_NQ, total_riders_stage, by = "Type_terrain") %>%
  filter(Type_terrain %in% c("Time Trial", "Flat", "Mountain", "Hilly Stage"))  %>% 
  mutate(pct_not_finish = (not_finished/total_riders)*100)
```

The following section will be analyzing the in-completion rate across the different types of stages. Each stage carries with it it's own unique difficulties and understanding where riders have historically shown the greatest weakness could be beneficial at understanding stages that should be targeted and where energy needs to be conserved for. In order to conduct this analysis the total number riders over who failed to complete each stage was divided by the total number competitors who have competed in the stage over time. The _stage_clean_ dataset lists riders who "did not finish", "over the time limit" and "not qualified" as "DNF", "OTL" and "NQ" as their rank for the stage, these ranks were tallied up for every stage as well as the participants for every stage and then divided over each other to produce the percentage rate of in-completion for each stage.  

```{r DNF-OTL-NQ, fig.cap = "The percentage of riders that have not finished the main for stages, since 1969"}
total_riders_dnf_terrain %>%
  ggplot(aes(x = fct_reorder(Type_terrain, -pct_not_finish),
             y = pct_not_finish)) +
  geom_col(stat = "identity") +
  ggtitle("The percentage of riders that failed to finish") +
  xlab("Stage Type") +
  ylab("Percentage") +
  theme_linedraw() 
```

Figure \@ref(fig:DNF-OTL-NQ) visualises the percentage of total riders that have failed to complete the specific stage types with the stage type on the x axis and the percentage on the y axis. The Mountain and Hilly stages show to be the hardest terrains for riders to finish. Percentage of riders who have failed to complete each stage are:

  - Mountain stage: 2.13% of all riders that have entered the stage have failed to complete it
  - Hilly stage: 1.61% of all riders that have entered the stage have failed to complete it
  - Flat stage: 0.61% of all riders that have entered the stage have failed to complete it
  - Time trial: 0.29% of all riders that have entered the stage have failed to complete it

Time trial's have the least percentage of failed to complete riders with .29% and Flat stages being over double that. Time trial stages are run individually and are usually shorter distances on most often on more flatter terrain these characteristics can make it safer with reduced physical risk and collision risk. This may show that time trials are vital stage to master given their low in-completion rate which could be due to their safer conditions, which could allow for skilled riders to maximise their abilities and use these stages to improve their time gap with competitors. Furthemore, given mountain stages and hilly stages show higher incompletion rates, it would indicate that tailoring training and strategy to these stages could be beneficial in the outcome of a riders race as well as, given the greater historical difficulty relative to the other stages as shown by the higher rate, these could be stages where a rider looks to target the competition by making these stages a strength in order to increase their position when other riders may struggle more. 




**The distance covered in Tour de France through the history**

```{r}

# The previous analysis only used the data from 1969. 
# In this analysis, we would not cut the period of the data
# We would use mostly the same code, but we remove the filter of year
# We also change the terrain type categorisation

stage_clean_stg_number_new <- stage_clean %>%
  group_by(stage_results_id) %>%
  separate(stage_results_id, c("stage", "stage_number"), "-") %>%
  mutate(year_stage = paste0(year, "-", stage_number)) 

tdf_stage_stg_number_new <- tdf_stages %>%
  mutate(year = year(Date),
         year_stage = paste0(year, "-", Stage)) %>%
  select(Stage, Date, Type, year, year_stage, Distance) %>%
  janitor::clean_names() 

tdf_stage_clean_new<-  tdf_stage_stg_number_new %>%
  left_join(stage_clean_stg_number, by = "year_stage") %>%
  select(stage_number, rank, rider, elapsed, year.x, distance, type, date) %>%
  rename(year = year.x)

tdf_stages_names_clean_new <- tdf_stage_clean_new %>%
  mutate(
    Type_terrain = case_when(
      str_detect(type, "mountain|Mountain|mountain(s)") ~ "Mountain",
      str_detect(type, "Flat|Plain") ~ "Flat",
      str_detect(type, "Individual time trial|Team time trial") ~ "Time Trial",
      str_detect(type, "Hilly") ~ "Hilly",
      str_detect(type, "Transition|Intermediate|Half") ~ "Transition"))


stage_type_group <- tdf_stages_names_clean_new %>%
  group_by(year, Type_terrain) %>%
  summarise(type_ave = mean(distance, na.rm = TRUE)) %>%
  pivot_wider(names_from = Type_terrain,
              values_from = type_ave) %>%
  replace_na(list(`Time Trial` = 0, Hilly = 0, Transition = 0)) %>% #replace the NA
  mutate(total_mount_hill = Mountain + Hilly,
         total_dist = Mountain + Flat + Hilly + Transition + `Time Trial`,
         perc_mount_hill = total_mount_hill/total_dist * 100)

perc_mount_hill <- stage_type_group %>%
  select(year, perc_mount_hill)
```




```{r dist-data}

winners <- winners %>% mutate(year = year(start_date))

dist_data <- left_join(winners, perc_mount_hill, by = "year") %>%
  mutate(perc_mount_hill_cat = ifelse(perc_mount_hill < 40, "< 40",
                                      ifelse(perc_mount_hill >= 40 & perc_mount_hill < 50 , "40 - 49.9",
                                             ifelse(perc_mount_hill >= 50 & perc_mount_hill < 60 , "50 - 59.9",
                                                    ">= 60")))) %>%
  mutate(perc_mount_hill_cat = factor(perc_mount_hill_cat, levels = c("< 40", "40 - 49.9", "50 - 59.9", ">= 60")))


```

```{r dist-plot, fig.cap = "The distance of Tour de France Route (1903-2019)"}
dist_plot <- ggplot(dist_data) +
  geom_point(aes(x = year,
             y = distance,
             colour = perc_mount_hill_cat)) +
  labs(x = "Year",
       y = "Distance (km)",
       title = "The distance of Tour de France Route through the history (1903-2019)",
       colour = "Percentage of mountain and hilly stage") +
  theme_bw() +
  geom_smooth(aes(x = year, y = distance),
              method = "loess", se = FALSE, color = "steelblue", alpha = 0.5, size = 0.5) +
  scale_x_continuous(breaks=seq(1903, 2019, 10)) +
  theme(legend.position = "bottom",
        text = element_text(size = 10),
        plot.title.position = "plot") 


  
ggMarginal(dist_plot, margins = 'y', size=4, type = "histogram", 
           fill = "steelblue", 
           color = "steelblue",
           alpha = 0.7)
```




**The speed of the winners. How does the bicycle technology development and doping usage affect?**

```{r speed-data}
dist_data <- dist_data %>% 
  mutate(speed = distance/time_overall,
         bicycle_tech = ifelse(year >= 1937 & year < 1972 , "derailleur introduced",
                               ifelse(year >= 1972 & year < 1985, "lighweight bike introduced",
                                      ifelse(year >= 1985 & year < 1990, "disc wheel introduced",
                                             ifelse(year >= 1990, "other technologies developed",
                                                    "pre-revolutionery tech")))),
         doping = ifelse(year >= 1990 & year < 2000, "doping is widespread, no test",
                         ifelse(year >= 2000 & year < 2008, "doping is tested",
                                ifelse(year >= 2008, "cyclist also monitored using blood passport",
                                       "pre-doping widespread")))) %>%
  mutate(bicycle_tech = factor(bicycle_tech, levels = c("pre-revolutionery tech", 
                                            "derailleur intorudeced", 
                                            "lighweight bike intoduced", 
                                            "disc wheel introduced",
                                            "other technologies developed")))

# https://www.adelaidenow.com.au/sport/how-tour-de-france-cycle-race-evolved-over-100-years-ago/news-story/f759f06f3ae23d4faf4fcba089e37cd6?sv=5bfd117ddc9268e7db9f3cf2b5d0fa1

# https://www.andrewaage.com/post/analyzing-tour-de-france-data/
```


```{r speed-plot, fig.height=6, fig.width=8, fig.cap = "Speed of the winners through the history (1903-2018)"}

cuts1 <- data.frame(Ref="Doping is widespread, no test", vals=c(1990))
cuts2 <- data.frame(Ref="Doping is tested", vals=c(2000))
cuts3 <- data.frame(Ref="Blood passport usage", vals=c(2008))
cuts <- rbind(cuts1, cuts2, cuts3)



speed_plot <- ggplot(filter(dist_data, !is.na(speed))) +
  geom_point(aes(x = year,
                 y = speed,
                 colour = bicycle_tech)) +
  geom_smooth(aes(x = year, y = speed),
              method = "loess", se = FALSE, color = "steelblue", alpha = 0.5, size = 0.5) +
  geom_vline(data = cuts , aes(xintercept=vals), colour = "tomato", alpha = 0.5, size = 0.5) +
  geom_text(mapping = aes(x = vals,
                          y = 0,
                          label = Ref,
                          hjust = 0,
                          vjust = -0.5,
                          angle = 90),
            data = cuts,
            size = 3) + 
  scale_x_continuous(breaks=seq(1900, 2020, 10)) +
  scale_y_continuous(breaks=seq(20, 50, 5))+
  theme_bw() +
  theme(text = element_text(size = 10),
        legend.position = "bottom") +
  labs(title = "Speed of the winners through the history (1903-2018)",
       subtitle = "Observing the association of speed with bicycle technology and doping usage",
       x = "Year",
       y = "Speed (km/hour)",
       colour = "Bicycle technology") +
  guides(colour=guide_legend(nrow=2,byrow=TRUE))
  

ggMarginal(speed_plot, margins = 'y', size=4, type = "density", 
           fill = "steelblue", 
           color = "steelblue", 
           alpha = 0.4 )

```




## Is the Tour de France becoming more competitive?

With the increase in the number of holding of the Tour de France and the development of technology, the equipment becomes more advanced and the team's strategy becomes more mature, which may lead to more intense competition in the competition. In the following, we will analyse whether the Tour de France has become more competitive based on the data.

```{r, fig.cap="Average hours taken by the winner to complete the race"}
winner_hours <- winners %>%
  group_by(decade = 10 * (year(start_date) %/% 10)) %>%
  summarise(time_overall = mean(time_overall, na.rm = TRUE)) %>%
  ggplot() +
  geom_line(aes(x = decade, y = time_overall), colour="steelblue") +
  ylab("Average Hours") +
  xlab("Year") +
  ggtitle('Tour de France winers average finish time (per decade)') + 
  theme_classic() 

ggplotly(winner_hours)
```

As showing in Figure 5, the average of total hours taken by the winner to complete the race are increased before 1920 and reached its peak around 1920 which is over two hundred hours. After 1920, the average total hours began to decline, and until the past decades, the average total hours have dropped to less than ninty hours. However, this result is still not enough support that the riders is getting faster than before and the competition getting more competitive, because the reduction in average total hours is also affected by the distance of the races.

```{r, fig.cap="Average difference in finishing time between the race winner and the runner up"}
winner_time_margin <- winners %>%
  group_by(decade = 10 * (year(start_date) %/% 10)) %>%
  summarise(time_margin = mean(time_margin, na.rm = TRUE)) %>%
  ggplot() +
  geom_line(aes(x = decade, y = time_margin * 60), colour="steelblue") +
  ylab("Average time difference (min)") +
  xlab("Year") +
  ggtitle('Tour de France winers average time margin (per decade)') + 
  theme_classic() 

ggplotly(winner_time_margin)
```

Next we can look at the time margin trend (Refer to Figure 6), the line represents the trend of time margin over decades. From the figure, it is obvious that the time margin is decreasing, which means that the time gap between the winner and the second place is getting smaller. By 2010, the time margin was already less than three minute. This means that regardless of the length of the distance, the performance difference between the riders has become smaller and the competition has become more intense. A slight mistake may lose the chance of winning.









# Conclusion {-#mysection}

At the conclusion of out analysis it is evident a rider must possess a range of different attributes and strategies in place in order to win the general classification. Specifically, the analysis highlights the importance of targeting appropriate stages to attack the competition, training for the right terrain and building the most efficient body to endure the gruelling 23 day tour in order to come out victorious with the general classification. 

Furthermore, as tour organisers organised new trophies, the number of riders in contention of the yellow jersey have dwindled over the years as riders focuse on specific terrains, making it more difficult for overall winners to lead the stage. Each year, tour organisers vary the stages for the course, forcing riders to tailor their tactics for the different adversities in each course.

Overall winners do not necessarily win all stages, but have appeared to be consistent in ranks. In most cases, overall winners climb the ranks gradually, ranking less than 40 and stages 1-7 and less than 20 from stages 8 onwards respectively. Our analysis implied that overall winners may start wearing the yellow jersey at stage 17 onwards.

Our analysis asserts overall winners are all rounders and deploy strategic tactics. On top of their physiological traits, overall winners are usually formidable at climbing mountains. Additionally, overall winners does not triumph without his team as the speediest rider may not surpass a group of cyclists. Team allows their team leader take advantage of aerodynamics to ride at higher speeds with less energy expended, preserving his energy for critical stages.

\clearpage

# References

