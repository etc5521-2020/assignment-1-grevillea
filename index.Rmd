---
title: "ETC5521 Assignment 1"
subtitle: "Tour de france"
team: Grevillea
author:
  - Samuel Lyubic
  - Brendi Ang
date: "`r Sys.Date()`"
output:
    bookdown::html_document2: default
---

[This assignment is for ETC5521 Assignment 1 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}

# Potential Questions

**Primary Question:**  
What are the most important characteristics and attributes to win the tour and how have they evolved over time?

**Secondary:**  
1. What is the average speed of overall winners for each stage? 
  - Are they faster in a certain terrain (e.g. hill, mountain, flat)? 
  - How important are stage wins for the overall winner? 
    - *Note:* complements Q3.
  - Are there certain tracks/terrains that most riders fail to complete (i.e. NA in rank/elapsed in stage data)?

2. Is there a change in biological/physical traits of overall winners over the years? 
  - Do overall winners, top sprinters or climbers have similar features (e.g. body type, age)? Were they consistent over the years?
  - Are competitors younger/older these days?
  - Is a certain team producing winners more prevalently? - e.g. Do these teams have good salary, nutritionists etc.
  - Is a certain nation producing winners more prevalently?

3. How many stages does an overall winner usually lead by? Do they usually wear the yellow jersey from start to end?
  - Is there a specific trend (e.g. Win in the last few stages or do they win certain terrains like mountain stages)?      
  - *Note:* don't have to win any stages or have the most points to be overall winner
  - How are they ranked in each stage?

# Introduction and motivation

**Intro:**
- History of Tour De France
- What is it? How to win?
  - Special jerseys
  - Different stages
  - Team sport
  
## History of Tour De France

Tour De France ("Le Tour") is an annual men's bicycle race that in modern days encompasses a 21-day course that covers approximately 3,500km. It is predominantly held in France while often passing through other countries. Cyclists from around the world gather for a chance to win the prestigious 'Tour De France' trophy, along with a cash prize of â‚¬450,000.

Split into various stages:
- flat stages
- hilly stages
- mountain stages (incl. 5 summit finishes)
- individual ad team time trials
- rest days

One stage is performed every day, covering approximately 225km& about 5.5hours to complete. Each stage has a winner, & the rider that completes the most stages in the shortest amount of time wins the overall title. 

## The Jersey Hierarchy

The colour and patterns of jerseys  to look out for in every race. As a brief overview,
the same coloured jerseys are worn within teams, current road champions get to wear their team jerseys with their country's colour& reigning world champions wears their team jerseys with stripes. The jersey hierarchy, which is based on the how old the competition has been implemented, serves as a symbolic purpose:

**Yellow: General classification - Race leader**: "General Classification" is the oldest and main competition sought after by competitors, where the winner of this will win the overall title. after each stage, the rider with the lowest aggregate time gains the privilege to wear the most coveted jersey in the race, the yellow jersey.  

**Red& white polka-dot: Mountains classification - meilleur grimpeur (Best climber)**: With stages containing climbs, points are awarded to riders who reach the summit first. Thus, this worn by the rider who at the start of each stage, has the largest number of climbing points.

**Green: Points classification - Top sprinter**:   
- Worn by rider who has the greatest number of points at the start of each stage, where points are given to first 15 riders to finish a stage. Furthermore, additional points are also given to first 15 riders to cross a pre-determined 'sprint' point in each stage. These jerseys are usually worn by 'sprinters'.

**White: Young rider classification - Most impressive rider, under 26 years old**: Determined the same as general classification, where it is restricted to riders that are under 26 years old.  

## Teams

You may ask, why have teams when there is only one individual champion for the General Classification? '*Domestiques*' (french in servant), a term frequently used to describe riders who support a team leader to win stages and accumulate the least elapsed time at the end of the race. For instance, to set up a rider for a sprint, one rider rides at a high speed, with the team's sprinter following behind to cut wind resistance and conserve energy; This is known as 'Lead-out Trains'. Teams typically consists of 8 riders and are denoted by numbers 1-9, where the team leader wears the lowest number.

# Data description

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.align = 'center')

# load libraries
library(tidyverse)
library(lubridate)
library(kableExtra)
library(tdf)
# For web scraping
library(polite)
library(rvest)
```

```{r read-data, include = FALSE}
stage_clean <- read.csv(here::here("data/stage_data.csv"))
winners <- read.csv(here::here("data/tdf_winners.csv"))
tdf_stages <- read.csv(here::here("data/tdf_stages.csv"))
```

The data used for this analysis originates from the `tdf` R package, which is essentially a container for the  `editions` data frame. This data set is hosted on [GitHub](https://github.com/alastairrushworth/tdf) and is readily available. The data set encompasses the historic data about Tour de France riders, stages and winners.

`winners` corresponds to a condensed version of the `editions` data frame; Each row corresponds to an edition of the Tour De France event for a given year, spanning all the way to the first edition in 1903 to the latest tournament as of today (2019). Some of the variables include:


```{r}
glimpse(tdf_winners)
```

- `winners ` variables contains the overall winner's biographical data and information about the race for a given edition, which comprises of:  
- `start date` start of the Tour De France edition
- `winner name` name of the overall winner (*i.e. winner of the General Classification)
- `distance` aggregate route distance (in km) covered by the entire race
- `time margin` difference between winning time and runner up (in hours) 
- `stage_wins` stages won by the overall winner
- `stages led` number of stages spent in the yellow jersey
- `height` overall winner's height (in meters)
- `weight` overall winner's weight (in kilograms)
- `born` overall winner's date of birth
- `full_name` overall winner's full name
- `nationality` overall winner's nationality


The `editions` dataset contains variable `stage results`, which represents a list of lists where each element contains a list of stage results pertaining to a particular year or edition of Tour De France. When we unnest, or flatten it back to its regular columns, we get `tdf_stages` and `stage_clean` dataset.


```{r explore-tdf-stages, include = FALSE}
glimpse(tdf_stages)
```

The `tdf_stages` data set depicts the details of the stage winners at each stage of an edition, with stage type/terrain, the distance between the start location and end location of the stage. Some of the variables includes:
- `stage`: Stage number of the edition
- `date`: Date of stage
- `origin` and `destination`: Start and end location of the stage
- `distance`: Distance (in KM) for the stage
- `type`: type of stage
- `winner`: Name of the stage winner

```{r explore-stage-data, include = FALSE}
glimpse(stage_clean)
```

The `stage_clean` is expands on the `tdf_stages` dataset, including results of all riders and their ranks at every stage where each row corresponds to the result of a particular rider such as points accumulated for the stage. This data set includes variables such as:

`edition`: Race edition pertaining to the year
`rider`: The name of the rider/participant
`age`: Age of rider at that point in time
`rank`: Rank of the rider for the stage
`elapsed`: Time elapsed for the stage


## Problems encountered 

Initially, we downloaded all the data set (.csv format) directly from the ['tidytuesday github link'](https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-04-07/readme.md), which was the most convenient way to load and read-in the Tour De France data set. However, we discovered errors in the `time` and `elapsed` variables in the `stage_clean` where the period objects were incorrect. Thus, we opted to use the cleaning script found in the same github link and made some adjustments such as changing the object names to reproduce the same data set that was intended. 

Furthermore, `tdf_stages` data set only provided data till the 2017 edition while the actual dataset covered all the way to 2019. Accordingly, we web scraped the data from these the Wikipedia (for [2018](https://en.wikipedia.org/wiki/2018_Tour_de_France) and [2019](https://en.wikipedia.org/wiki/2019_Tour_de_France)) to obtain the stages data set for 2018 and 2019. These Wiki pages corresponds to how the actual data set obtained its data, making it straightforward to structure the data to a tidy format analogous with the `tdf_stages` data set, assuring smooth binding of the data.


# Analysis and findings

[FILL] Should include at least one plot or numerical summary for each of your questions, that helps the reader arrive at an answer. You should also write paragraphs describing the methods, summaries and findings. 

# References

## How have races& riders evolved over time?

 1. How do stage speeds change for overall winners across the tour?

In order to assess the overall winners average stage speed the stage_clean dataset, which contained each riders elapsed timem and tdf_stages, which contained each individual stage information, was required to be combined together. This was achieved by making a new variable that contained the stage number and date which then acted as the key. To display the stage results of overall winning riders only, the names had to align for an inner join to be used however, the rider names in the stage_clean dataset provided the surname first which required a regular expression to be used to target the riders first name and generate a new variable with the appropriate order of their names. Furthermore, given the variation in each stage from year to year, the stages have been grouped by the three main types of stages. The dataset has been filtered to show results that are post the begining of the "doping era" of cycling which saw the emergence of the banned substance EPO which to this day is still are still hard to detect @{McKay2013}. 

```{r plot-speeds, fig.cap = "Average stage speeds across the three main terrains for overall winners in km/h, since 1988"}
#speeds across different stages
winner_stages_combined %>%
  mutate(stage_number = as.numeric(stage_number)) %>%
  group_by(stage_number, Type_terrain) %>%
  summarise(avg_speed = mean(speed_kmhr)) %>%
  ggplot(aes(x = as.factor(stage_number),
             y = avg_speed,
             color = Type_terrain)) +
  geom_point() +
  theme_linedraw() +
  ggtitle("Overall winners average stage speeds") +
  ylab("Average Speed, km/h") +
  xlab("Stage Number") +
  scale_y_continuous(breaks = seq(0, 50, 5)) +
  labs(color = "Stage Types")

```

Figure \@ref(fig:plot-speeds) illustrates the average stage speed for all overall winning riders since 1988, across all the stages and stage types with stage number on the x axis and the average speed in kilometers per hour on the y axis. It is evident that speeds on mountain stages are on average lower then hilly, flat and time trial stages with the highest speeds coming from the time trial stages. 

  - Mountain stage types
    - Mountain stages start historically have at the earliest started on day two. The overall winning riders ride across stage 2 mountain terrain at an average speed of 40.18. Over the course of the tour de france there is an evident negative trend with speeds declining over the course of the tour and ending in the 20th stage with an average speed of 33.92 km/h. There are two up ticks in the average speed evident the first between stages 6 and 8, from 35.52 km/h to 37.95, and stage 11 and stage 13, from 34.01 to 37.10. 
  - Flat stage types
    - Flate stage average speeds are relativly consistent with a few patches of increased speeds across the journey of the Tour de France. Starting at just over 42.03 km/hr at stage one the speeds stay relatively consistent until stage seven, from which there is slightly increasing curvature in the figure that shows speeds increased to 43.95 km/h in stage 9 and 44.17 km/h in stage 11 and following a similar "u" shaped pattern through to stage 19. The relatively large drop in average speeds for the final three rounds can be attributed to the "Champs Elysees" round which is a final celebratory round @{Mitchell M}, a few years have seen the tour have less then 21 rounds such as 2001 where there were 20.
  - Time trials
    - Time trial average speeds hol the highest recorded average speeds out of all the stage types. The speeds have relatively consistent fluctuation from stage to stage, outside of stage 16 and 17. Stage one registers the highest average speed across all stage types with a maximum speed of 49.53 km/h and stage 16 recoreded the minimum overall speed of 22.52 km/h. 
  - Hilly stages
    - Open at stage one with an average of 42.03 km/h and then fluctuate relatively constantly between its peak speed at stage two of 44.53 km/h and the minimum overall observed average speed 37.04 at stage 20.

## Are there certain stage types/terrains that most riders fail to complete?

Under the rank variable riders who failed to complete a stage were classified with a "DNF", "OTL" or "NQ", which stand for did not finish, over the time limit and not qualified. These labels were identified and tallied up for each stage type and then divided by the total number of entrants per type since 1969 to find the percentage of riders that failed to complete each terrain type. 

```{r DNF-OTL-NQ, fig.cap = "The percentage of riders that have not finished the main for stages, since 1969"}
total_riders_dnf_terrain %>%
  ggplot(aes(x = fct_reorder(Type_terrain, -pct_not_finish),
             y = pct_not_finish)) +
  geom_col(stat = "identity") +
  ggtitle("The percentage of riders that failed to finish") +
  xlab("Stage Type") +
  ylab("Percentage") +
  theme_linedraw() 
```

Figure \@ref(fig:DNF-OTL-NQ) visualises the percentage of total riders that have failed to complete the specific stage types with the stage type o the x axis and the percentage on the y axis. The most strenuous and and gruelling stages of the Tour are the Mountain and Hilly stages whicg show to be the hardest terrains for riders to finish with the highest percentage of riders failing to complete mountain stages being 2.13% and Hilly stages with 1.61%. Time trial's have the least percentage of failed to complete riders with .29% and Flat stages being over double that. Time trial stages are run individually and are usually shorter distances on most often on more flatter terrain these characteristics make it much safer, reduced physical risk with strain and collision, and relatively easier than the other three which makes sense as to why has the lowst non-completion rate while, Flat stages, despite being flat run a higher risk of collision which could explain it having a percentage almost double that of time trail incompletion rates. 

# 2. Is there a change in biological traits of overall winners over the years?

The Tour de France conists of a range of stage types across different terrains which range from flat groud, mountains and hilly. Each of these terrains may suit a certain type of body compostion given the different elements and requirements for the specific terrain such as flat terrain and time trials better suit sprinters who are more likely to have a more muscular frame to generate power and mountain stages better suited for a slimmer build given how strenuous and endurance based those stages are. Given the overall winner is required to have the lowest elapsed time, this section will be assessing how the winners physical and biological traits match up with the other competitors and stage specialists.

## Do overall winners, top sprinters or climbers have similar features (e.g. body type, age)? 

The top climbers, sprinters and time trialists were isolated by targetting the winners of the flat and mountain stages in the rdf_stages section, with the top 6 riders from each category being selected. However, their height and weight were not included in the original dataset and in order to compare the body types with the overall winner their dimensions were sourced online and compiled into a tibble and then row binded together.

```{r body-types-combine-and-plot, fig.cap = "Comparison of overall winner, sprinter and climbers body types"}
rider_body_types %>%
  ggplot(aes(x = weight,
             y = height)) +
  geom_point() +
  facet_wrap(~rider_type) +
  theme_linedraw() +
  ggtitle("Comparison of body types") +
  ylab("Height") +
  xlab("Weight")
```

Figure \@ref(fig:body-types-combine-and-plot) visualises the body types of climbers, time trialist, sprinters and the overall winner with weight along the x axis and height on the y axis. It is evident from the figure that elite climbers and overall winner have a relatively more similar body type and elite individual time trialist and sprinter have a more similar frame. Climbers and overall winners tend to be ligher then individual time trialist and sprinters however, all of their heights are relatively similar with climbers and overall winners ranging to lower heights. This could indicate that being built with a climbers body frame which is lighter may provide a better opportunity to be the overall winner of the tour.

## Are competitors younger/older these days?

Age often plays a big factor in the assessment of an athelete potential performance, with the developments in the medical, technological and scientific fields athelete's are seeming to continue to play for longer. The overall mean age was been calculated for each year starting rider from 1988 for relativity purposes given the impact of EPO from this point.

In order to assess the age trend that may exist at the Tour de France the stage_clean data set was used which contains all rider details from each Tour.   
```{r median-mean-age, fig.cap = "The averge age of riders at each Tour de France"}
mean_age_tdf <- stage_clean %>%
  filter(year >= "1988") %>%
  select(year, rider, age) %>%
  group_by(year, rider) %>%
  arrange(rider) %>%
  group_by(year, rider) %>%
  slice(1) %>%
  group_by(year) %>%
  summarise(mean_age = mean(age, na.rm = TRUE)) %>%
  arrange(desc(year))

mean_age_tdf %>%
  ggplot(aes(x = year,
             y = mean_age)) +
  geom_point() +
  geom_smooth(alpha = .1, se = FALSE, color = "#FFBE33") +
  theme_linedraw() +
  ggtitle("Average rider age") +
  xlab("Year") +
  ylab("Average") +
  scale_x_continuous(breaks = seq(1990, 2020, 5))
```

Figure \@ref(fig:median-mean-age) visualises the average ages of contesants from 1988 to 2020 with the year on the x axis and the average age on the y axis. The figure shows the average age has been increasing over time, going from and average age of 27.1 in 1998 to a peak of almost 30 with 29.67 in 2012 and ending up with an average age of 29.22 at the 2019 Tour. The advancement of cycling technolgies and development of equipment such as lighter frames and more aerodynmaic attire @{Haake2009} in conjunction with improvements in best practice and integration of sports science, could be a reason behind riders extending their career as physical ailments that would have halted riders in the past are now being dealt with more effectively and proactively @{SmithM}.

## How has age impacted overall results?

```{r age-winner, fig.cap = "Age of overall winners"}
winners %>%
  filter(start_date >= "1988-07-02") %>%
  mutate(year = year(start_date)) %>%
  ggplot(aes(x = year,
                 y = age)) + 
  geom_point(point = "blue") +
  geom_smooth(method = "lm", se = FALSE, color = "#FFBE33") +
  theme_linedraw() +
  ggtitle("Age of overall winners") +
  ylab("Age") +
  xlab("Date") +
  scale_x_continuous(breaks = seq(1988, 2019, 1)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

Figure \@ref(fig:age-winner) visualises the age of the overall winner since 1988 with the date on the x axis and the age on the y axis. A slight upward trend is present with quite a bit of variability in amongst the time frame which indicate that the age of winning riders is increasing however, it does not seem to be the most critical element given the distribution on both sides of the lm line. It is also worth noting that, given the EPO era that this time frame is inspecting, the increased riding/winng age could also be influenced by illicit substance use as was notoriously the case with Lance Armstrong @{WilsonJ} who won seven straight tours from 1999 aged 27 through to 2005 aged 32 as well as less well known riders such as Bjarne Liis who won 1996 aged 32 and also had admitted to doping @{FarrandS}. These substance based results among the potential others may have influenced the dataset given it is unclear what the overall age results would have been had doping not been present. 

## Is there a difference between the ages of overall winners and stage winners?

In order to assess if there was an age difference between overall winners and stage winners, the stage_clean dataset was filtered to only show first rank for each stage since 1988.

```{r plot-age-type-of-winner, fig.cap = "Difference in average age for overall winers and stage winners"}
  age_stage_winner %>%
  ggplot(aes(x = type_of_winner,
             y = age)) +
  geom_boxplot() +
  theme_linedraw() +
  ggtitle("Age of overall winner v stage winners") +
  xlab("Winner") +
  ylab("Age") +
  scale_y_continuous(breaks = seq(20, 38, 2))
```

Figure \@ref(fig:overall-winner-age-stage-winner-age) presents the age distribution of winners with overall winners and stage winners across the x axis and age along the y axis. Overall winners have a higher age median at around 29 years of age as opposed to 28 years for stage winners while, stage winners display both the youngest winner at 21 and the oldest at 36.

4. Is being part of team important?

## Are certain team producing winners more prevalently? 

All though there is an individual winner at the end of every Tour de France, it is deemed a team sport given how much each rider is aided by who they share a jersey with. Teams will look to protect their lead rider by looking to gain ideal position for their lead rider and assisting them in conserving energy through a range of different strategies @{HopkinsPhillips}. In order to assess the most prevelant teams in Tour de France, the data set was filtered to show results from 1969 which sees the re-introduction and professional sponsorship of teams @{McGann}. 

```{r most-prevelant-teams, fig.cap "Displays the teams with the most wins since 1969"}
team_names_to_date %>%
  select(start_date, winner_name, winner_team) %>%
  group_by(winner_team) %>%
  summarise(n = n()) %>%
  arrange(desc(n)) %>%
  filter(n >= 3) %>%
  ggplot(aes(x = fct_reorder(winner_team, n),
             y = n)) +
  geom_col(stat = "identity") +
  theme_bw() +
  ggtitle("Teams with the most wins") +
  xlab("Team Name") +
  ylab("Number of wins") +
  scale_y_continuous(breaks = seq(0, 8, 1))
```

Figure \@ref(fig:most-prevelant-teams) displays the most prevalent teams in Tour history since 1969 with the teams on the x axis and the number of wins on the y axis. This figure shows 5 teams which have domianted the results and collectively represented 60% of the winners since 1969. Specifically, Team Ineos who are considered the most dominant team in Tour history credit their performance to improved training habits and implementation of recovery techniques, evolving technologies and marginal gains across the board which collectievly add up to an overall better performance across the team. Furthermore, the financial backing of these larger teams attracts the top tier riders given the pay packets they are able to provide as well as being able to afford all the the state of the art practices that assist performance thus potentially improving their dominance relative to smaller teams @{LindseyJ}, which would indicate that the team a rider chooses/is chosen for is likely to have an impact on their opportunity to win.

## Is a certain nation producing winners/stage winners more prevalently?

```{r winner-nationality, fig.cap = "Figure displaying a time series of the countries each winner is from"}
winners %>%
  mutate(year = year(start_date)) %>%
  ggplot(aes(x = year,
             y = nationality)) +
  geom_point() +
  theme_linedraw() +
  ggtitle("Nationality of overall winner") +
  xlab("Year") + 
  ylab("Nationality") +
  scale_x_continuous(breaks = seq(1900, 2020, 5)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) 
```

Figure \@ref(fig:winner-nationality) visualises the distribution of countries each winner has been from with the year of the Tour on the x axis and the nationality on the y axis. The figure shows that Up until 1985 France and Belgium were the two most dominant countries from which winning riders were from. In 1986 the U.S. saw their first win and the most dominant nations since then have been the U.S.* Spain and Great Britain. This could be a result of globilisation of the sport and access and mobility with regards to training and travel, making it more accessible for riders, coaches and teams to train and operate in the most desired regions with the highest calibre of trainers. However, it should be noted this change comes around the time of the "doping era" which clearly has a large factor in the wins tallied by the United States.

```{r, eval = FALSE}
ggplot(winners ) +
  geom_bar(aes(x = year,          
               y = distance),
           stat = "identity") +
  theme_classic() 
```

```{r}
# insert year variable
winners  <- winners  %>%
  mutate(start_date = as.Date(start_date)) %>%
  mutate(year = year(start_date))
```


```{r tdf_dist}
tdf_dist <- ggplot(data = winners ) +
  geom_point(aes(x = year,
                 y = distance),
             colour = "#ff4d4d") +
  xlab("Year") +
  theme_classic()
```

```{r tdf-avg-speed}
tdf_avg_speed <- ggplot(winners ) +
  geom_point(aes(x = year,
                 y = distance / time_overall),
             colour = "blue") +
  labs(y = "Average Speed",
       x = "Year") +
  theme_classic()
```

```{r combine-dist-avg-speed}
gridExtra::grid.arrange(tdf_dist, tdf_avg_speed, ncol = 2)
```

- The total distance covered are decreasing over the years& has been fluctuating around 3,500km over the past two decades
- At first glance, it may seem that riders have it easy with the reduced distance.
- However, the average speed for each rider had been increasing gradually over the years
- This may be due to better professionalism in the sport, equipment& gears and smarter training.


```{r}
ggplot(winners) +
  geom_point(aes(x = year,
                 y = nationality,
                 colour = nationality),
             alpha = 0.6) +
  theme_minimal() 
```

- Many emerging countries such as Great Britian
- Countries that dominated in the past (e.g. France) are not winning as much now
# Quest for the Yellow Jersey

## Procedure
  
The purpose of this section is to explore the trends of overall winners. We start by answering the most basic question: "Do overall winners win all stages through the edition?". Here, we discovered that what some overall winners achieved in the early decades have not been achieved in contemporary editions. For instance, wearing the yellow jersey for all stages in the edition. So, we decided to hone in on the last two decades, 2000 - 2020. We studied how overall winners were ranked in each stage and stage type to examine if these riders specialised in any particular domain such as sprinting or climbing. For this section, we utilised regular expressions to manipulate character strings and relational joins to join data sets with matching observations.


```{r wrangle-stage-data, warning = FALSE}
# Parse stage number
stage_clean <- stage_clean %>%
  mutate(stage = str_extract(stage_results_id, "\\d+")) %>% 
  mutate(stage = as.factor(stage)) # change to factor for joins

# parse elapsed into lubridate::period variable
stage_clean <- stage_clean %>%
  mutate(elapsed = hms(elapsed))
```

```{r tdf-stages-2000s, warning = FALSE}
# Add year variable for joining table
tdf_stages <- tdf_stages %>% 
  mutate(date = as.Date(date)) %>%
  mutate(year = year(date))

tdf_stages_2000s <- tdf_stages %>%
  filter(between(year, 2000, 2019)) %>%
  rename(stage_winner = winner,
         stage_winner_country = winner_country)

# Change "P" to stage 0
## Represents prologue of the race, usually determines yellow jersey for race 1
tdf_stages_2000s$stage <- ifelse(tdf_stages_2000s$stage == "P", "0", as.factor(tdf_stages_2000s$stage)) 

# include year variable for join
winners <- winners %>%
  mutate(year = year(start_date))

# Extract overall winners' names
winners_2000s <- winners %>%
  filter(between(year, 2000, 2019)) %>%
  select(winner_name, year)

# Change order of winner names to match with stage_clean rider names
winners_2000s$winner_name <-
  str_replace(string = winners_2000s$winner_name, pattern = "([^ ]+) ([^ ]+)", replacement = "\\2 \\1")

# Extract stages details 
stage_winners_2000s <- stage_clean %>%
  filter(between(year, 2000, 2019)) %>%
  # include stage data of overall winner only
  inner_join(winners_2000s, by = c("year", "rider" = "winner_name")) %>% 
  left_join(tdf_stages_2000s, by = c("year", "stage")) %>% # Add stage details
  mutate(rank = as.numeric(rank)) # Change rank to numeric for plotting

# Filter out one NA rank
stage_winners_2000s <- stage_winners_2000s %>%
  filter(!is.na(rank)) %>%
  # Add decade variable, for plotting
  mutate(decade = case_when(
           between(year, 2000, 2009) ~ "2000 - 2009",
           between(year, 2010, 2020) ~ "2010 - 2019")) %>%
  mutate(year = as.factor(year))

stage_winners_2000s$stage_winner <- str_replace(string = stage_winners_2000s$stage_winner, pattern = "\\[.+\\]", replacement = "")

stage_winners_2000s <- stage_winners_2000s %>%
  # remove unnecessary paranthesis
  mutate(stage_winner = str_replace(string = stage_winners_2000s$stage_winner, pattern = "\\[.+\\]", replacement = "")) %>%
  # change sequence of names to match winner names
  mutate(stage_winner = str_replace(string = stage_winners_2000s$stage_winner, pattern = "([^ ]+) ([^ ]+)", replacement = "\\2 \\1"))
```

## A fallacy: Overall Winners leads all stages

```{r stages-led-plot, fig.cap = "How often do Overall Winners Wear the Yellow Jersey"}
ggplot(winners) +
  geom_point(aes(x = year,
                 y = stages_led,
                 ),
           alpha = 0.8) +
  geom_point(data = subset(winners, year %in% c(1928, 1934)), # Riders who led 22 stages
             aes(x = year,
                 y = stages_led,
                 ),
             colour = "#bc3a3a") +
  # Add text on years 1928 and 1934
  geom_text(data =  subset(winners, year %in% 1928), 
            aes(x = year * 0.9977, y = stages_led * 1.003, 
                label = "1928", 
                fontface = "bold")) +
  geom_text(data =  subset(winners, year %in% 1934), 
            aes(x = year * 1.002, y = stages_led * 1.003, 
                label = "1934", 
                fontface = "bold")) +
    geom_line(aes(x = year,
                 y = stages_led
                 ),
              alpha = 0.5) +
  scale_x_continuous(breaks =seq(from = 1900, to = 2020, by = 10),
                     labels =seq(from = 1900, to = 2020, by = 10)) +
  labs(y = "Stages led by Overall Winner",
       x = "Year") +
  theme_minimal() +
  ggtitle("How often do Overall Winners wear the Yellow Jersey?")
```

Many speculate that overall winners are all-rounder cyclists who consistently don the yellow jersey by winning all stages. Nevertheless, winning all 22 stages is not infeasible as Nicolas Frantz and Antonin Magne have both proven it in 1928 and 1934 respectively.

However, in majority of the editions, the line plot (\@ref(fig:stages-led-plot)) invalidates the conjecture, demonstrating that the stage led by overall winners have been shown vary greatly across most editions. The plot further reveals that overall winners can lead as little as 1 stage, indicating that they only led the tour at the very last stage. In addition, overall winners seem to lead in lower number of stages in the recent years as compared to earlier years.

## Ranks of Overall Winners in Different Stages

```{r ranks-by-stage-boxplot, fig.cap = "Ranks of Overall Winners across Stages"}
stage_winners_2000s %>%
  mutate(stage = as.integer(stage)) %>% 
  arrange(desc(stage)) %>%
ggplot(aes(y = as.factor(stage),
           x = rank,
           group = stage)) +
  geom_boxplot() +
  geom_point(alpha = 0.3) +
  theme_minimal() +
  scale_x_continuous(breaks = c(seq(from = 0, to = 150, by = 10))) +
  labs(y = "Stage",
       x = "Rank") +
  ggtitle("Ranks of Overall Winners across Stages from 2000 to 2019") +
  theme(plot.title = element_text(face = "bold", size = 14))
```

The box plot (Figure \@ref(fig:ranks-by-stage-boxplot)) depicts the ranks of al overall winners from 2000 - 2019 for each stage. In most cases, overall winners are ranked lower than 30, which may imply that the winners have a consistent pace that puts them in these ranks. Moreover, it can be observed that in the last few stages, particularly 17-20, overall winners pick up their pace and usually attain top 10 rankings This may suggest that overall winners are wearing the yellow jersey at this point forward. By the same token, this reiterates that the consistent pace of overall winners, where riders who exerted more energy in earlier stages are unable to keep up with the overall winners. 

Why are the ranks of overall winners in stage 21 rather high and peculiar? Stage 21, or better known as the "Champs-Ã‰lysÃ©es" stage, representing a symbolic street in Paris, France. As a tradition, riders set a truce to their competition to have a celebratory moment of tranquillity, chatting and even celebrating with glasses of champagnes in the final kilometres. For this reason, the rankings of overall winners are diverse.

## Do Overall Winners Thrive in Certain Stage Types or Terrain?

```{r winners-by-stage, fig.width = 8}
# Categorise stages into 4 main stages in tdf
stage_winners_2000s <- stage_winners_2000s %>%
  mutate(type = case_when(
    str_detect(type, "mountain") ~ "Mountain",
    str_detect(type, "Mountain") ~ "Mountain",
    str_detect(type, "Flat") ~ "Flat",
    str_detect(type, "trial") ~ "Time trial",
    str_detect(type, "Hilly") ~ "Hilly")) %>%
  filter(!is.na(type)) # filter out 2 uncategorised stage type 
```

```{r stage-distance-2000s}
# Compute total distance for an edition
stage_winners_2000s <- stage_winners_2000s %>%
  group_by(edition) %>%
  mutate(total_dist = sum(distance, na.rm = TRUE)) # remove one row with NA distance
```

```{r stage-type-prop, fig.cap = "Proportions of stage type for an edition (2000 - 2020)"}
ggplot(stage_winners_2000s) +
  geom_bar(aes(x = year,
               y = total_dist,
               fill = type,
               group = type),
           stat = "identity",
           position = "fill",
           alpha = 0.8) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_fill_brewer(palette = "Dark2") +
  labs(y = "Total Distance",
       x = "Year") +
  ggtitle("Proportions of stage type for an edition (2000 - 2020)") +
  theme(panel.grid = element_blank(),
        plot.title = element_text(face = "bold", size = 14))
```

Despite century steeped traditions, tour organisers arrange the race course in a different manner each year. Nonetheless, it is with a goal in mind, to include a balance of the different types of races. In most editions, the largest proportion of the rest are mountain stages, followed by flat stages (Figure \@ref(fig:stage-type-prop)). In 2007, the edition only consisted of mountain stages and time trials. 


```{r ranks-by-stage-tbl}
# Filter to stages that overall winners won
rank_summ <- stage_winners_2000s %>%
  filter(rank > 5) %>%
  group_by(type) %>%
  tally() %>%
  arrange(desc(n)) 

rank_summ <- stage_winners_2000s %>%
  group_by(type) %>%
  tally() %>%
  inner_join(rank_summ, by = "type") %>%
  rename(total_stage_type = n.x,
         ranked_below_5 = n.y) %>%
  # Find proportion& add '%' symbol
  mutate(prop_rank_type = paste(round((ranked_below_5/total_stage_type)*100, 
                                      digits = 2),
                                "%", sep = "")) %>%
  relocate(total_stage_type, .after = ranked_below_5) %>%
  rename(`Stage Type` = type,
         `Stage Type Total Count` = total_stage_type,
         `Ranked 5th or below` = ranked_below_5,
         `Proportion` = prop_rank_type) 

rank_summ %>%
  kable(caption = "Proportion of Overall Winners Ranked 5th and Below by Stage Type") %>%
  kable_styling(bootstrap_options = c("hover", "striped"))
```

```{r ranks-by-stage-type, fig.cap = "Rankings of Overall Winners (2000 - 2019) by Stage Type"}
stage_winners_2000s %>%
  ggplot(aes(x = type,
           y = rank)) +
  geom_violin(aes(fill = type),
              width = 1.2,
              alpha = 0.7) +
  geom_boxplot(width = 0.2) +
  geom_point(alpha = 0.2) +
  scale_fill_brewer(palette = "Dark2") +
  scale_y_continuous(breaks = c(seq(from = 0, to = 100, by = 10),
                                seq(from = 100, to = 150, by = 25))) +
  theme_bw() +
  labs(x = "Type",
       y = "Rank") +
  ggtitle("Rankings of Overall Winners (2000 - 2019) by Stage Type") +
  theme(legend.position = "bottom",
        panel.grid.minor.y = element_blank(),
        plot.title = element_text(face = "bold", size = 14))
```

Figure \@ref(fig:ranks-by-stage-type) illustrates that overall winners are versatile riders who performs relatively well at each stage type. This is also manifest in table \@ref(tab:ranks-by-stage-tbl), which establishes that overall winners are ranked 5 and below in approximately 7 in 10 races for all types of stage. This plot also reinforces the idea that overall winners does not always perform great in all stages, as seen with the variability of ranks at each type of stage.

It is almost always that the overall winners are formidable at climbing mountain. Considering the steep climbs, thin air at high altitudes and narrow descents in mountain stages, these stages have the largest potential for time gaps and for riders to make the grade and set them apart from other riders. Table \@ref(tab:ranks-by-stage-tbl) demonstrates that overall winners thrive in mountain stages, where they are ranked 5 or less in at least three out of four mountain stages. Although this may be true, Figure \@ref(fig:ranks-by-stage-type) also show that one can also expect large variability in rankings of overall winners when it comes to these gruelling mountain stages.

Amongst the different stage types, Figure \@ref(fig:ranks-by-stage-type) shows that the rankings of overall winners had the least median rank and smallest variations when it came to time trials. This implies two things; First, overall winners must be physically skilled to win individual time trials. Individual time trials tests their endurance and solo strengths by forcing them to negotiate the course comprising of curved roads, small-scale slopes and multiple terrain types while keeping a steady and appropriate pace. Next, it conveys that they customarily have great teams as it requires precise strategy and cooperation amongst the team. For instance, team's *domestiques* (French for servants) work in unison to allow for drafting (shield from wind resistance by riders in front) to facilitate a smoother ride for the team leader and ensure he arrives at crucial moments of the race with little energy expended. This is especially complex as teams must find an ideal pace despite their diverse body types and skills. 

With flat stages accounting for nearly one third (`r rank_summ$total_stage_type[1]/nrow(stage_winners_2000s)`) of all stages in a given edition, it is essential for overall winners to be skilled at sprints. Although *Q2* highlighted that flat stages are typically dominated by sprinters, who are usually a muscular rider with a larger body type,  overall winners have proven to be they are successful in these stages too. They are ranked at a median rank of approximately 15 (Figure \@ref(fig:ranks-by-stage-type)) and have attained rank 5 and below in about 73% of the time for all flat stages in the last two decades.


## Did not work 


```{r stage-data-cumsum, eval = FALSE}
# Find total time taken to complete a stage
stage_clean <- stage_clean %>%
  mutate(hour_to_mins = hour(elapsed)*60,
         sec_to_mins = round((second(elapsed)/60), digits = 4),
         mins = minute(elapsed)
         ) 

# Compute total mins per stage for each rider
stage_clean <- stage_clean %>%
  rowwise() %>%
  mutate(total_mins = sum(c(hour_to_mins, sec_to_mins, mins))) # Round to 4 decimal places
  
# Find cumulative sum after each stage 
stage_clean <- stage_clean %>%
  group_by(edition, rider) %>%
  mutate(cum_total_mins = cumsum(total_mins)) 


# Maybe I can colour by the stage type? Need to take stage info from tdf_stages
stage_clean %>%
  filter(year == 2012) %>%
  ggplot() +
  geom_point(aes(x = stage,
                 y = cum_total_mins),
             alpha = 0.01
             ) 

# Create new data set with only winners
# Layer over the graph with another geom_point, coloured in yellow
# Join table using year and rider (because rider may win more than 1 year)
```

```{r test, eval = FALSE}
# Create new data set with only winners
winners <- winners %>%
  mutate(year = year(start_date))

# Create new data set with winners for 2019
winners_2017 <- winners %>%
  filter(year == 2017) 

# Insert stage records by joining table
winners_2017 %>%
  left_join()

# Insert stage records by joining table with regular expression
winner_name <- winners_2017$winner_name
winner_match <- str_c("[", winner_name, "]",  
                      collapse = "|")

str_subset(string = stage_2017$rider, pattern = winner_match)
str_view_all(stage_2017$rider, "Chris Froome", match = TRUE)

# Layer over the graph with another geom_point, coloured in yellow
```



```{r, eval = FALSE}
# Transform factor to original numeric values
stage_clean$stage <- as.numeric(levels(stage_clean$stage))[stage_clean$stage]

# Find first& last stage of each year
finish_summ <- stage_clean %>%
  group_by(year) %>%
  # Filter to stage 1, not 0 because some riders don't race in prologue
  filter(stage == 1 | stage == max(stage)) %>%
  summarise(first_stage = min(stage),
            last_stage = max(stage)) %>%
  # pivot longer to facilitate join
  pivot_longer(cols = first_stage:last_stage,
               names_to = "first_last_stage",
               values_to = "stage")

# Filter to only first& last stages of each edition
stage_finish <- stage_clean %>%
  inner_join(finish_summ, by = c("year", 
                                 "stage")) %>%
  # filter out years with error in rider data
  filter(!year %in% c(1939, 1964, 1966, 1967, 1968, 1972, 1976, 1977)) 

stage_finish <- stage_finish %>%
  group_by(year, stage, first_last_stage) %>%
  summarise(total_riders = n()) 
```


```{r, eval = FALSE}
stage_finish_wide <- stage_finish %>%
  pivot_wider(
    id = year,
    names_from = first_last_stage,
    values_from = c(total_riders, stage)
  ) %>%
  rename(first_stage = stage_first_stage,
         last_stage = stage_last_stage) %>%
  # include % of riders who finished entire race
  mutate(finish_prop = total_riders_last_stage/total_riders_first_stage)
```

```{r, eval = FALSE}
ggplot(data = stage_finish_wide,
       aes(x = year)) +
  geom_point(aes(y = total_riders_first_stage),
             colour = "steelblue") +
  geom_point(aes(y = total_riders_last_stage,
                 colour = total_riders_last_stage),
             colour = "red") +
  geom_segment(
    aes(y = total_riders_first_stage,
        xend = year, 
        yend = total_riders_last_stage), alpha = 0.5) 
```

```{r finish-rate, eval = FALSE}
stage_finish_wide %>%
  ggplot(aes(x = year,
                 y = finish_prop)) + 
  geom_point() +
  labs(y = "% of Riders who Finished all Stages",
       x = "Year") +
  geom_smooth(method = "lm",
              span = 0.2) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) + # Remove panel grids
  scale_x_continuous(breaks =seq(from = 1900, to = 2020, by = 10),
                     labels = seq(from = 1900, to = 2020, by = 10)) 
```


