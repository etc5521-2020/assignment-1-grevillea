---
title: "ETC5521 Assignment 1"
subtitle: "Your title"
team: grevillea
author:
  - Brendi Ang
  - Samuel Lyubic
date: "`r Sys.Date()`"
output:
    bookdown::html_document2: default

---

[This assignment is for ETC5521 Assignment 1 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}

# Potential Questions

**Primary Question:**  
What are the most important characteristics and attributes to win the tour and how have they evolved over time?

**Secondary:**  
1. What is the average speed of overall winners for each stage? 
  - Are they faster in a certain terrain (e.g. hill, mountain, flat)? 
  - How important are stage wins for the overall winner? 
    - *Note:* complements Q3.
  - Are there certain tracks/terrains that most riders fail to complete (i.e. NA in rank/elapsed in stage data)?

2. Is there a change in biological/physical traits of overall winners over the years? 
  - Do overall winners, top sprinters or climbers have similar features (e.g. body type, age)? Were they consistent over the years?
  - Are competitors younger/older these days?
  - Is a certain team producing winners more prevalently? - e.g. Do these teams have good salary, nutritionists etc.
  - Is a certain nation producing winners more prevalently?

3. How many stages does an overall winner usually lead by? Do they usually wear the yellow jersey from start to end?
  - Is there a specific trend (e.g. Win in the last few stages or do they win certain terrains like mountain stages)?      
  - *Note:* don't have to win any stages or have the most points to be overall winner
  - How are they ranked in each stage?

# Introduction and motivation

**Intro:**
- History of Tour De France
  - Where is it held?
  - How has it evolved?
- What is it? How to win?
  - Special jerseys
  - Different stages
  - Team sport
  
## History of Tour De France

Tour De France ("Le Tour") is an annual men's bicycle race that in modern days encompasses a 21-day course that covers approximately 3,500km. It is predominantly held in France while often passing through other countries. Cyclists from around the world gather for a chance to win the prestigious 'Tour De France' trophy, along with a cash prize of â‚¬450,000.

## Stages

Split into 21 stages:
- 9 flat stages
- 3 hilly stages
- 8 mountain stages (incl. 5 summit finishes)
- 1 individual time trials (usually on the penultimate)
- 2 rest days

At present, one stage is performed every day, covering approximately 225km& about 5.5hours to complete. Each stage has a winner, & the rider that completes the most stages in the shortest amount of time wins the overall title.

Permitted disqualification time in which riders must finish (Winners time + pre-determined % of that time)

*Time trials:*  
- Usually 2-3 time trials
- 1st stage in modern tours is usually a prologue (or short trial), deciding who wears the yellow jersey on opening day.

## Teams

You may ask, why have teams when there is only one individual champion for the General Classification?? 'Domestiques', a term frequently used to describe riders who support a team leader to win stages and accumulate points to hopefully win the tour. For instance, to set up a rider for a sprint, one rider rides at a high speed, with the team's sprinter following behind to cut wind resistance and conserve energy; This is known as 'Lead-out Trains'.

For the bulk of the race, cyclists don't usually ride as fast as they can throughout the race, but cycle in a main group known as a peloton. 

## What do jerseys represent?

The same coloured jerseys are worn within teams, current road champions get to wear their team jerseys with their country's colour& reigning world champions wears their team jerseys with stripes.

## The Jersey Hierarchy

**Yellow: General classification - Race leader**  
- All stages are timed, and the rider with the lowest aggregate time gains the privilege to wear this yellow jersey
- "General Classification" is the oldest and main competition sought after by competitors, where the winner of this will win the overall title
-  it's not uncommon to have five or more different leaders throughout the three weeks of racing.

**Red& white polka-dot: Mountains classification - meilleur grimpeur (Best climber)**   
- Worn by the rider who at the start of each stage, has the largest number of climbing points
- With stages containing climbs, points are awarded to riders who reach the summit first.

**Green: Points classification - Top sprinter**  
- Worn by rider who has the greatest number of points at the start of each stage.
- Points are given to first 15 riders to finish a stage
- Additional points are also given to first 15 riders to cross a pre-determined 'sprint' point in each stage
- The number of points awarded varies depending on the type of stage; Flat stages having the most points at the finish while time trials& mountain stages have the least.

**White: Young rider classification - Most impressive rider, under 26 years old**  
- Determined the same as general classification, where it is restricted to riders that are under 26 years old


# Data description

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

# load libraries
library(tidyverse)
library(lubridate)
library(kableExtra)
library(tdf)
# For web scraping
library(polite)
library(rvest)
```

```{r read-data, include = FALSE}
stage_data <- read.csv(here::here("data/stage_data.csv"))
tdf_winners <- read.csv(here::here("data/tdf_winners.csv"))
tdf_stages <- read.csv(here::here("data/tdf_stages.csv"))
```

This data set originates from the `tdf` R package, which is essentially a container for the  `editions` data frame encompassing the historic data about Tour de France riders, stages and winners. This data set is hosted on this [github link](https://github.com/alastairrushworth/tdf) and is readily available for use.

`tdf_winners` corresponds to the `editions` data frame; Each row corresponds to an edition of the Tour De France event for a given year, spanning all the way to the first edition in 1903 to the latest tournament as of today (2019).

```{r explore-tdf-winners}
glimpse(tdf_winners)
```
- `tdf_winners` variables contains the overall winner's biographical data and information about the race for a given edition, which comprises of:  
- `start date` start of the Tour De France edition
- `winner name` name of the overall winner (*i.e. winner of the General Classification)
- `distance` aggregate route distance (in km) covered by the entire race
- `time margin` difference between winning time and runner up (in hours) 
- `stage_wins` stages won by the overall winner
- `stages led` number of stages spent in the yellow jersey
- `height` overall winner's height (in meters)
- `weight` overall winner's weight (in kilograms)
- `born` overall winner's date of birth
- `full_name` overall winner's full name
- `nationality` overall winner's nationality

*Do we have to name all of them?* 

```{r}
glimpse(stage_data)
```

```{r}
glimpse(tdf_stages)
```

- Condensed version of `stage_data` tibble, comprising of only the winners of all stages.
Include data...

Initially, we downloaded all the data set (.csv format) directly from the ['tidytuesday github link'](https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-04-07/readme.md), which was the most convenient way to load and read-in the data. However, we discovered errors in the `time` and `elapsed` variables in the `stage_data` where the period objects were incorrect. 

Thus, for this particular data set, we opted to use the cleaning script found in the same github link; We made some minor adjustments such as changing the object names to reproduce the same data set that was intended. 

Furthermore, `tdf_stages` data set only provided till the 2017 edition where the actual dataset covered all the way to 2019.


# Analysis and findings

[FILL] Should include at least one plot or numerical summary for each of your questions, that helps the reader arrive at an answer. You should also write paragraphs describing the methods, summaries and findings. 

# References





# Exploring the data

## How have races& riders evolved over time?

```{r, eval = FALSE}
ggplot(tdf_winners) +
  geom_bar(aes(x = year,          
               y = distance),
           stat = "identity") +
  theme_classic() 
```

```{r}
# insert year variable
tdf_winners <- tdf_winners %>%
  mutate(start_date = as.Date(start_date)) %>%
  mutate(year = year(start_date))
```


```{r tdf_dist}
tdf_dist <- ggplot(data = tdf_winners) +
  geom_point(aes(x = year,
                 y = distance),
             colour = "#ff4d4d") +
  xlab("Year") +
  theme_classic()
```

```{r tdf-avg-speed}
tdf_avg_speed <- ggplot(tdf_winners) +
  geom_point(aes(x = year,
                 y = distance / time_overall),
             colour = "blue") +
  labs(y = "Average Speed",
       x = "Year") +
  theme_classic()
```

```{r combine-dist-avg-speed}
gridExtra::grid.arrange(tdf_dist, tdf_avg_speed, ncol = 2)
```

- The total distance covered are decreasing over the years& has been fluctuating around 3,500km over the past two decades
- At first glance, it may seem that riders have it easy with the reduced distance.
- However, the average speed for each rider had been increasing gradually over the years
- This may be due to better professionalism in the sport, equipment& gears and smarter training.


```{r}
ggplot(tdf_winners) +
  geom_point(aes(x = year,
                 y = nationality,
                 colour = nationality),
             alpha = 0.6) +
  theme_minimal() 
```

- Many emerging countries such as Great Britian
- Countries that dominated in the past (e.g. France) are not winning as much now

# The Quest for the Yellow Jersey

```{r wrangle-stage-data, warning = FALSE}
# Parse stage number
stage_data <- stage_data %>%
  mutate(stage = str_extract(stage_results_id, "\\d+")) %>% 
  mutate(stage = as.factor(stage)) # change to factor for joins

# parse elapsed into lubridate::period variable
stage_data <- stage_data %>%
  mutate(elapsed = hms(elapsed))
```

```{r tdf-stages-2000s, warning = FALSE}
# Add year variable for joining table
tdf_stages <- tdf_stages %>% 
  mutate(date = as.Date(date)) %>%
  mutate(year = year(date))

tdf_stages_2000s <- tdf_stages %>%
  filter(between(year, 2000, 2019)) %>%
  rename(stage_winner = winner,
         stage_winner_country = winner_country)

# Change "P" to stage 0
## Represents prologue of the race, usually determines yellow jersey for race 1
tdf_stages_2000s$stage <- ifelse(tdf_stages_2000s$stage == "P", "0", as.factor(tdf_stages_2000s$stage)) 

# include year variable for join
tdf_winners <- tdf_winners %>%
  mutate(year = year(start_date))

# Extract overall winners' names
winners_2000s <- tdf_winners %>%
  filter(between(year, 2000, 2019)) %>%
  select(winner_name, year)

# Change order of winner names to match with stage_data rider names
winners_2000s$winner_name <-
  str_replace(string = winners_2000s$winner_name, pattern = "([^ ]+) ([^ ]+)", replacement = "\\2 \\1")

# Extract stages details 
stage_winners_2000s <- stage_data %>%
  filter(between(year, 2000, 2019)) %>%
  # include stage data of overall winner only
  inner_join(winners_2000s, by = c("year", "rider" = "winner_name")) %>% 
  left_join(tdf_stages_2000s, by = c("year", "stage")) %>% # Add stage details
  mutate(rank = as.numeric(rank)) # Change rank to numeric for plotting

# Filter out one NA rank
stage_winners_2000s <- stage_winners_2000s %>%
  filter(!is.na(rank)) %>%
  # Add decade variable, for plotting
  mutate(decade = case_when(
           between(year, 2000, 2009) ~ "2000 - 2009",
           between(year, 2010, 2020) ~ "2010 - 2019")) %>%
  mutate(year = as.factor(year))

stage_winners_2000s$stage_winner <- str_replace(string = stage_winners_2000s$stage_winner, pattern = "\\[.+\\]", replacement = "")

stage_winners_2000s <- stage_winners_2000s %>%
  # remove unnecessary paranthesis
  mutate(stage_winner = str_replace(string = stage_winners_2000s$stage_winner, pattern = "\\[.+\\]", replacement = "")) %>%
  # change sequence of names to match winner names
  mutate(stage_winner = str_replace(string = stage_winners_2000s$stage_winner, pattern = "([^ ]+) ([^ ]+)", replacement = "\\2 \\1"))
```

# A fallacy: Overall Winners leads all stages

```{r}
tdf_winners <- tdf_winners %>%
  mutate(year = year(start_date)) %>%
  # Add decade variable for plotting
  mutate(decade = round(year -4.5, -1)) %>%
  mutate(decade = case_when(
    decade == 1900 ~ "1900-1909",
    decade == 1910 ~ "1910-1919",
    decade == 1920 ~ "1920-1929",
    decade == 1930 ~ "1930-1939",
    decade == 1940 ~ "1940-1949",
    decade == 1950 ~ "1950-1959",
    decade == 1960 ~ "1960-1969",
    decade == 1970 ~ "1970-1979",
    decade == 1980 ~ "1980-1989",
    decade == 1990 ~ "1990-1999",
    decade == 2000 ~ "2000-2009",
    decade == 2010 ~ "2010-2019")
  )
  
ggplot(tdf_winners) +
  geom_point(aes(x = year,
                 y = stages_led,
                 ),
           alpha = 0.8) +
  geom_point(data = subset(tdf_winners, year %in% c(1928, 1934)), # Riders who led 22 stages
             aes(x = year,
                 y = stages_led,
                 ),
             colour = "#ff3333") +
  # Add text on years 1928 and 1934
  geom_text(data =  subset(tdf_winners, year %in% 1928), 
            aes(x = year * 0.9977, y = stages_led * 1.003, 
                label = "1928", 
                fontface = "bold")) +
  geom_text(data =  subset(tdf_winners, year %in% 1934), 
            aes(x = year * 1.002, y = stages_led * 1.003, 
                label = "1934", 
                fontface = "bold")) +
    geom_line(aes(x = year,
                 y = stages_led
                 ),
              alpha = 0.5) +
  scale_x_continuous(breaks =seq(from = 1900, to = 2020, by = 10),
                     labels =seq(from = 1900, to = 2020, by = 10)) +
  labs(y = "Number of times yellow jersey worn (Stages Led)",
       x = "Year") +
  theme_minimal() 
```

Many speculate that overall winners are all-rounder cyclists who consistently don the yellow jersey by winning all stages. Nevertheless, winning all 22 stages is not infeasible as Nicolas Frantz and Antonin Magne have both proven it in 1928 and 1934 respectively.

However, in majority of the editions, the line plot above invalidates the conjecture, demonstrating that the stage led by overall winners have been shown vary greatly across most editions. The plot further reveals that overall winners can lead as little as 1 stage, indicating that they only led the tour at the very last stage. Moreover, overall winners seem to lead in lower number of stages in the recent years as compared to earlier years.

## How do Overall Winners Fare in stages

```{r}
stage_winners_2000s %>%
  mutate(stage = as.integer(stage)) %>% 
  arrange(desc(stage)) %>%
ggplot(aes(y = as.factor(stage),
           x = rank,
           group = stage)) +
  geom_boxplot() +
  geom_point(alpha = 0.3) +
  theme_minimal() +
  scale_x_continuous(breaks = c(seq(from = 0, to = 150, by = 10))) +
  labs(y = "Stage",
       x = "Rank") 
```

The box plot depicts the ranks of al overall winners from 2000 - 2019 for each stage. In most cases, overall winners are ranked lower than 30, which may imply that the winners have a consistent pace that puts them in these ranks. Moreover, it can be observed that in the last few stages, particularly 17-20, overall winners pick up their pace and usually attain top 10 rankings This may suggest that overall winners are wearing the yellow jersey at this point forward. By the same token, this reiterates that the consistent pace of overall winners, where riders who exerted more energy in earlier stages are unable to keep up with the overall winners. 

Why are the ranks of overall winners in stage 21 rather high and peculiar? Stage 21, or better known as the "Champs-Ã‰lysÃ©es" stage, representing a symbolic street in Paris, France. As a tradition, riders set a truce to their competition to have a celebratory moment of tranquillity, chatting and even celebrating with glasses of champagnes in the final kilometres. For this reason, the rankings of overall winners are diverse.

## How are Overall Winners ranked by Stage Type?

```{r winners-by-stage, fig.width = 8}
# Categorise stages into 4 main stages in tdf
stage_winners_2000s <- stage_winners_2000s %>%
  mutate(type = case_when(
    str_detect(type, "mountain") ~ "Mountain",
    str_detect(type, "Mountain") ~ "Mountain",
    str_detect(type, "Flat") ~ "Flat",
    str_detect(type, "trial") ~ "Time trial",
    str_detect(type, "Hilly") ~ "Hilly")) %>%
  filter(!is.na(type)) # filter out 2 uncategorised stage type 
```

```{r stage-distance-2000s}
# Compute total distance for an edition
stage_winners_2000s <- stage_winners_2000s %>%
  group_by(edition) %>%
  mutate(total_dist = sum(distance, na.rm = TRUE)) # remove one row with NA distance
```

```{r stage-types-200s}
ggplot(stage_winners_2000s) +
  geom_bar(aes(x = year,
               y = total_dist,
               fill = type,
               group = type),
           stat = "identity",
           position = "fill",
           alpha = 0.8) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_fill_brewer(palette = "Dark2") +
  labs(y = "Total Distance",
       x = "Year") +
  theme(panel.grid = element_blank()) 
```

Despite century steeped traditions, tour organisers arrange the race course in a different manner each year. Nonetheless, it is with a goal in mind, to include a balance of the different types of races. In most editions, the largest proportion of the rest are mountain stages, followed by flat stages. In 2007, the edition only consisted of mountain stages and time trials. The bar chart above displays the stage type from 2000 - 2019.

```{r ranks, fig.cap = "Rankings of Overall Winners (2000 - 2019) by Stage Type"}
stage_winners_2000s %>%
  ggplot(aes(x = type,
           y = rank)) +
  geom_violin(aes(fill = type),
              width = 1.2,
              alpha = 0.7) +
  geom_boxplot(width = 0.2) +
  geom_point(alpha = 0.2) +
  scale_fill_brewer(palette = "Dark2") +
  scale_y_continuous(breaks = c(seq(from = 0, to = 100, by = 10),
                                seq(from = 100, to = 150, by = 25))) +
  theme_bw() +
  theme(legend.position = "bottom",
        panel.grid.minor.y = element_blank()) +
  labs(x = "Type",
       y = "Rank") +
  ggtitle("Rankings of Overall Winners (2000 - 2019) by Stage Type")
```

```{r rank-summary}
# Filter to stages that overall winners won
rank_summ <- stage_winners_2000s %>%
  filter(rank > 5) %>%
  group_by(type) %>%
  tally() %>%
  arrange(desc(n)) 

rank_summ <- stage_winners_2000s %>%
  group_by(type) %>%
  tally() %>%
  inner_join(rank_summ, by = "type") %>%
  rename(total_stage_type = n.x,
         ranked_below_5 = n.y) %>%
  mutate(prop_rank_type = round((ranked_below_5/total_stage_type)*100, digits = 2))


rank_summ %>%
  kable() %>%
  kable_styling(bootstrap_options = c("hover", "striped"))
```

Figure \@ref(fig:ranks) *ref* Overall winners are commonly versatile riders who performs relatively well at each stage type. This is also manifest in table *ref*, which establishes that overall winners are ranked 5 and below in approximately 7 in 10 races for all types of stage. This plot also reinforces the idea that overall winners does not always perform great in all stages, as seen with the variability of ranks at each type of stage.

It is almost always that the overall winners are formidable at climbing mountain Considering the steep climbs, thin air at high altitudes and narrow descents in mountain stages, these stages have the largest potential for time gaps and for riders to make the grade and set them apart from other riders. Table *ref* demonstrates that overall winners thrive in mountain stages, where they are ranked 5 or less in at least three out of four mountain stages. Although this may be true, figure *ref* demonstrates that one can also expect large variability in rankings of overall winners when it comes to these gruelling mountain stages.

Individual time trials tests their endurance and solo strengths by forcing them to negotiate the course comprising of curved roads, small-scale slopes and multiple terrain types while keeping a steady and appropriate pace. Overall winners' ranks in time trials conveys that they customarily have great teams. Team time trials brings team strategy back into the equation; Team's domestiques (French for servants) work in unison to allow for drafting (shield from wind resistance by riders in front) to facilitate a smoother ride for the team leader and ensure he arrives at crucial moments of the race with little energy expended. Similarly, teams must find an ideal pace despite the diverse body types and skills.

With flat stages accounting for nearly one third (`r rank_summ$total_stage_type[1]/nrow(stage_winners_2000s)`) of all stages in a given edition, it is essential for overall winners to be skilled at sprints. Although *Q2* highlighted that flat stages are typically dominated by sprinters, who are usually a muscular rider with a larger body type,  overall winners have proven to be they are successful in these stages too. They are ranked at a median rank of 15 (fig *ref*) and have attained rank 5 and below in about 73% of the time for all flat stages in the last two decades.


















## Did not work



```{r stage-data-cumsum, eval = FALSE}
# Find total time taken to complete a stage
stage_data <- stage_data %>%
  mutate(hour_to_mins = hour(elapsed)*60,
         sec_to_mins = round((second(elapsed)/60), digits = 4),
         mins = minute(elapsed)
         ) 

# Compute total mins per stage for each rider
stage_data <- stage_data %>%
  rowwise() %>%
  mutate(total_mins = sum(c(hour_to_mins, sec_to_mins, mins))) # Round to 4 decimal places
  
# Find cumulative sum after each stage 
stage_data <- stage_data %>%
  group_by(edition, rider) %>%
  mutate(cum_total_mins = cumsum(total_mins)) 


# Maybe I can colour by the stage type? Need to take stage info from tdf_stages
stage_data %>%
  filter(year == 2012) %>%
  ggplot() +
  geom_point(aes(x = stage,
                 y = cum_total_mins),
             alpha = 0.01
             ) 

# Create new data set with only winners
# Layer over the graph with another geom_point, coloured in yellow
# Join table using year and rider (because rider may win more than 1 year)
```

```{r test, eval = FALSE}
# Create new data set with only winners
tdf_winners <- tdf_winners %>%
  mutate(year = year(start_date))

# Create new data set with winners for 2019
winners_2017 <- tdf_winners %>%
  filter(year == 2017) 

# Insert stage records by joining table
winners_2017 %>%
  left_join()

# Insert stage records by joining table with regular expression
winner_name <- winners_2017$winner_name
winner_match <- str_c("[", winner_name, "]",  
                      collapse = "|")

str_subset(string = stage_2017$rider, pattern = winner_match)
str_view_all(stage_2017$rider, "Chris Froome", match = TRUE)

# Layer over the graph with another geom_point, coloured in yellow
```



```{r, eval = FALSE}
# Transform factor to original numeric values
stage_data$stage <- as.numeric(levels(stage_data$stage))[stage_data$stage]

# Find first& last stage of each year
finish_summ <- stage_data %>%
  group_by(year) %>%
  # Filter to stage 1, not 0 because some riders don't race in prologue
  filter(stage == 1 | stage == max(stage)) %>%
  summarise(first_stage = min(stage),
            last_stage = max(stage)) %>%
  # pivot longer to facilitate join
  pivot_longer(cols = first_stage:last_stage,
               names_to = "first_last_stage",
               values_to = "stage")

# Filter to only first& last stages of each edition
stage_finish <- stage_data %>%
  inner_join(finish_summ, by = c("year", 
                                 "stage")) %>%
  # filter out years with error in rider data
  filter(!year %in% c(1939, 1964, 1966, 1967, 1968, 1972, 1976, 1977)) 

stage_finish <- stage_finish %>%
  group_by(year, stage, first_last_stage) %>%
  summarise(total_riders = n()) 
```


```{r, eval = FALSE}
stage_finish_wide <- stage_finish %>%
  pivot_wider(
    id = year,
    names_from = first_last_stage,
    values_from = c(total_riders, stage)
  ) %>%
  rename(first_stage = stage_first_stage,
         last_stage = stage_last_stage) %>%
  # include % of riders who finished entire race
  mutate(finish_prop = total_riders_last_stage/total_riders_first_stage)
```

```{r, eval = FALSE}
ggplot(data = stage_finish_wide,
       aes(x = year)) +
  geom_point(aes(y = total_riders_first_stage),
             colour = "steelblue") +
  geom_point(aes(y = total_riders_last_stage,
                 colour = total_riders_last_stage),
             colour = "red") +
  geom_segment(
    aes(y = total_riders_first_stage,
        xend = year, 
        yend = total_riders_last_stage), alpha = 0.5) 
```

```{r finish-rate, eval = FALSE}
stage_finish_wide %>%
  ggplot(aes(x = year,
                 y = finish_prop)) + 
  geom_point() +
  labs(y = "% of Riders who Finished all Stages",
       x = "Year") +
  geom_smooth(method = "lm",
              span = 0.2) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) + # Remove panel grids
  scale_x_continuous(breaks =seq(from = 1900, to = 2020, by = 10),
                     labels = seq(from = 1900, to = 2020, by = 10)) 
```






