---
title: "ETC5521 Assignment 2"
subtitle: "Tour de france"
team: Grevillea
author:
  - Dewi Lestari Amaliah
  - Yiwen Jiang
  - (Samuel Lyubic)
  - (Brendi Ang)
date: "`r Sys.Date()`"
output:
    bookdown::html_document2:
      keep_tex: yes
      number_sections: yes
      citation_package: biblatex
      toc: true
      toc_float: true
bibliography: references.bib
biblio-style: authoryear-comp
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.align = 'center')

# load libraries
library(tidyverse)
library(kableExtra)
library(lubridate)
library(tdf)
library(plotly)
library(ggExtra)
library(ggforce)
library(patchwork)
# For web scraping
library(polite)
library(rvest)
library(ggrepel)
library(naniar)
library(gganimate)
library(gifski)
library(png)
```

[This assignment is for ETC5521 Assignment 1 by Team `r rmarkdown::metadata$team` comprising of `r knitr::combine_words(rmarkdown::metadata$author)`.]{style="color:#006DAE;"}

# Introduction

The Tour de France is a cycling tournament that is held in France annually which spans across 21 stages over 23 gruelling days. It is considered one of the most prestigious races that elite cyclists can partake in given the level of difficulty of riding through the ranging beautiful French landscapes (@EEB).  Despite being an individual event, riders travel through the whole country in teams of eight in order to strategically position the team leader in the best position to win the general classifications. This report mainly analyses the changes in the Tour de France over the past hundred years and the changes in riders’ characteristics. Our statistical programming used for analysis is _R_ and _Rstudio_.

## Motivation

Tour De France ("Le Tour") is an annual men’s bicycle race that in modern days encompasses a 21-day course that covers approximately 3,500 km. It is predominantly held in France while often passing through other countries.  (@britannica2020). The teams would pass through long countryside roads, steep alpine regions and tight city areas, covering terrain ranging from rolling hills, long flat grounds and steep mountainous. The types of terrain dispersed across the different stages over the 23 days. The rider that completes the most stages in the shortest amount of time wins the overall title.

Due to the long duration of the race, the intelligence or athletic ability of the riders are not the only factors in winning the race. The key to winning the competition also lies in the choice of strategy. Besides, with technological changes in the past hundred years and people's living standards have improved, various changes have taken place in the Tour de France. We will present our findings of the Tour de France through the exploration of the recording data from 1903 to 2019.


## Data Source

The original source of the Tour de France data set is from the `tdf` package written by @tdf. The data is then provided and available to download in the [TidyTuesday's GitHub repository](https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-04-07/readme.md) by @jthomasmock. The data contain the competition and winners' information over 106 years from 1903 to 2019. The dataset prepared for analysis of how the competition changes across over a hundred years. It includes the information of 106 winners and the information of 21 stages for each rider from 106 competitions. There are three data sets regarding Tour de France available in this repository, namely `tdf_winners.csv`, `stage_data.csv`, and `tdf_stages.csv`. The `tdf_stages.csv` data only covered the period up to 2017, so we got the data from 2018 and 2019 year from Wikipedia [@wikiTDF2018] and [@wikiTDF2019].

```{r read-data, include = FALSE}
stage_clean <- read.csv(here::here("data/stage_data.csv"))
winners <- read.csv(here::here("data/tdf_winners.csv"))
tdf_stages <- read.csv(here::here("data/tdf_stages.csv"))
```

## Data Limitation

```{r missing-value, fig.cap="Visualise the missing value in winners data", fig.align= "center"}
winners %>%
  vis_miss(sort_miss = TRUE)
```

- From Figure \@ref(fig:missing-value), we can see that there are seven variables that have missing values. The missing values in variable of `full_name`, `died`, and `nickname` were not really matter since we would not use these variables. However, we would use `height`, `weight`, `time_overall`, and `time_margin` variables. Hence, we have to handle these missing value. We finally decided to just omit these missing values because these variables are very specific to a person. It is hard to only use, for example an average to impute the values, because the overall time for winner each year must be different and the slight gap of time can affect the result of the competition.   
-	Many factors affect the rider's race performance, such as the weather conditions on the day of the race, and the rider's psychological factors. We cannot analyse all the aspects that affect the outcome of the competition.   
-	The time frame in the dataset are not consistent. `tdf_stages` data inside `tdf` package only provided data till the 2017 edition while the other two data covered all the way to 2019. Therefore, when using this data for analysis, we must consider whether to discard the data after 2017 or try to complete the data. If the analysis is for prediction, the data in recent years is relatively important, and it is unreasonable to discard the data in recent years. However, when we choose to complete the data after 2017, it is necessary to ensure the consistency of the data, such as the method to record the data may be varied between different institutions.  

# Data Description


The data set records competition information of Tour de France published on Alastair Rushworth's [Github](https://github.com/alastairrushworth/tdf). The data recorded the competition information since the first organised in 1903, and 106 competitions been held since then.

The Tour de France is a men's multi-stage cycling race held annually in France and nearby countries. It was established in 1903 to increase the sales of the newspaper L'Auto. This event has become an important cultural event for European fans.

This dataset includes the information of 106 winners, stages of each competition, and the riders' information of each stage in the competition. The time frame of the data recording started in 1903 and until 2019. Alastair Rushworth collected the recording information from various websites and other places and then integrated it into the dataset. The dataset was separated into three data files and provided by `.csv` format. The following are the variables in each data.

- The `tdf_winner` data comes from _tdf_winners.csv_. The data contains information about 106 winners of the Tour de France from 1903 to 2019. The part of the variables is showing in Table \@ref(tab:winners-table).  

```{r winners-table, echo=FALSE}
winners_info <- tibble(Variable = c("edition", "start_date", "winner_name", "winner_team", "distance", 
                                    "time_overall", "time_margin", "height", "weight", 
                                    "age", "nationality"),
                          Class = c("integer", "double", "character", "character", "double", "double", "double", 
                                    "double", "double", "integer", "character"),
                          Description = c("Edition of the Tour de France", "Start date of the Tour", 
                                          "Winner's name", 
                                          "Winner's team (NA if not on a team)", 
                                          "Distance traveled in KM across the entire race", 
                                          "Time in hours taken by the winner to complete the race",
                                          "Difference in finishing time between the race winner and the runner up",
                                          "Height in meters",
                                          "Weight in kg",
                                          "Age as winner",
                                          "Nationality")) 

winners_info %>%
  kable(booktabs = TRUE,
        caption = "Variables in tdf_winners data") %>%
  kable_styling(bootstrap_options =  c("striped", "hover", "condensed", "responsive"), 
                full_width = F, 
                position = "center")
```

- The `stage_data` data comes from _stage_data.csv_. The data contains ranking information for each stage of the annual race. The variables is showing in Table \@ref(tab:stage-clean-table). 

```{r stage-clean-table, echo=FALSE}
stage_data_info <- tibble(Variable = c("edition", "year", "stage_results_id", "rank", "time", "rider", "age", 
                                       "team", "points", "elapsed", "bib_number"),
                          Class = c("integer", "double", "character", "character", "double", "character", "integer",
                                    "character", "integer", "double", "integer"),
                          Description = c("Race edition", 
                                          "Year of race", 
                                          "Stage ID", 
                                          "Rank of racer for stage", 
                                          "Time of racer",
                                          "Rider name",
                                          "Age of racer",
                                          "Team (NA if not on team)",
                                          "Points for the stage",
                                          "Time elapsed stored as lubridate::period",
                                          "Bib number")) 

stage_data_info %>%
  kable(booktabs = TRUE,
        caption = "Variables in stage_data data") %>%
  kable_styling(bootstrap_options =  c("striped", "hover", "condensed", "responsive"), 
                full_width = F, 
                position = "center")
```

- The `stage_data` data comes from _stage_data.csv_. The data contains information of each stage for the annual race. The variables is showing in Table \@ref(tab:stage-table). 

```{r stage-table, echo=FALSE}
stage_info <- tibble(Variable = c("Stage", "Date", "Distance", "Origin", "Destination", "Type", "Winner", "Winner_Country"),
                          Class = c("character", "double", "double", "character", "character", "character", "character", "character"),
                          Description = c("Stage Number", 
                                          "Date of stage", 
                                          "Distance in KM", 
                                          "Origin city", 
                                          "Destination city",
                                          "Stage Type",
                                          "Winner of the stage",
                                          "Winner's nationality")) 

stage_info %>%
  kable(booktabs = TRUE,
        caption = "Variables in tdf_stages data") %>%
  kable_styling(bootstrap_options =  c("striped", "hover", "condensed", "responsive"), 
                full_width = F, 
                position = "center")
```

## Relevant Questions

The dataset is primarily used to analysis the changes on the Tour de France over a hundred years. The primary question to answer from this dataset is __how the performance of those riders are?__ After an overview of the primary question, we will conduct more specific analysis through the secondary questions as showing below:

1. _What are the characteristics of Tour de France winner riders?_ 
2. _How does the distance and speed of the Tour de France change?_
3. _Is the Tour de France becoming more competitive?_


## Data cleaning processes

The dataset has used come from the Alastair Rushworth's Data Package `tdf` package. The dataset contains information about the overall winning rider for each edition of the race. The winner's biographical information and the results for each stage in each edition. To install the package, use ` install_github("alastairrushworth/tdf")`.  

-	The `winner` data can be imported from `editions` in the `tdf` package; we only need to filter out the `stage_results` variable.  
-	The `stage_data` dataset is also import by `tdf::editions`, the stage information are been nested on the `stage_results` variable. We use the `unnest_longer()` function to a rectangle the nested `stage` data into a tidy tibble, and then use the flatten_df() function to flatten a list of lists into a simple vector. This process is essential because `stage` data nested in the `editions` data, we cannot read `stage` data directly from `editions` data. Finally, select the relevant variables and use the `year()` function in the `lubridate` package to extract the year of each race.   
-	It is the most convenient way to directly read the `tdf_stages` data from the `tdf` package, but it only provided data till the 2017 year while the actual dataset covered to 2019. Thus, we opted to use the cleaning script found in the [GitHub Tidy Tuesday page](https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-04-07/readme.md) [@jthomasmock].  Furthermore, our debugging process includes renaming inconsistent variable names, extracting components of date-time objects and using regular expressions to fix the structure of character strings to reproduce the same data set that intended. In addition, we web scraped the data from Wikipedia (@wikiTDF2018 and @wikiTDF2019) to obtain the stages data set for 2018 and 2019. These Wiki pages correspond to how the actual data set obtained its data; Thus, binding the data was straightforward as the structure the data was analogous with the `tdf_stages` data set.    

<details><summary>Expand here to see part of the data cleaning codes </summary>  

```{r data-cleaning, eval=FALSE, echo=TRUE}
library(tidyverse)
library(tdf) # install at: https://github.com/alastairrushworth/tdf

winners <- tdf::editions %>% 
  select(-stage_results)

all_years <- tdf::editions %>% 
  unnest_longer(stage_results) %>% 
  mutate(stage_results = map(stage_results, ~ mutate(.x, rank = as.character(rank)))) %>% 
  unnest_longer(stage_results) 

stage_all <- all_years %>% 
  select(stage_results) %>% 
  flatten_df()

combo_df <- bind_cols(all_years, stage_all) %>% 
  select(-stage_results)

stage_clean <- combo_df %>% 
  select(edition, start_date,stage_results_id:last_col()) %>% 
  mutate(year = lubridate::year(start_date)) %>% 
  rename(age = age...25) %>% 
  select(edition, year, everything(), -start_date)

winners %>% 
  write_csv(here::here("2020", "2020-04-07", "tdf_winners.csv"))

stage_clean %>% 
  write_csv(here::here("2020", "2020-04-07", "stage_data.csv"))

```

</details>

# Analysis and findings

By overview of the Tour de France competition, first, we began to go through the performance of these winners and also the riders. We use the `tdf_winners` data to visualise how many times the riders have won the competition. Then use the `stage_clean` data to see how they perform on each of the stages in the competition.

```{r winner-times, fig.cap="The number of times the rider win the Tour de France"}
winners %>%
  count(winner_name, sort = TRUE) %>%
  filter(n > 1) %>%
  ggplot(aes(reorder(winner_name, n), n)) +
  geom_col(width = 0.8,
           alpha = 0.8,
           color = "#85929E",
           fill = "#85929E") +
  labs(x = NULL, y = NULL) +
  geom_text(aes(label = n, y = n + 0.5)) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        panel.background = element_blank()) +
  coord_flip()
```

Refer to Figure \@ref(fig:winner-times); it presents the rank of the number of times the rider won the Tour de France in history. Lance Armstrong has won the competition seven total times, which is higher than most of the riders.  This brings us to an interesting question, does the winner achieve high rank or extraordinary performance in most of the stages?

```{r}
tdf_stages_animation <- tdf_stages %>%
  mutate(year = year(Date),
         stage = Stage)

stages_joined <- stage_clean %>%
  extract(stage_results_id, "stage", "stage-(.*)") %>%
  inner_join(tdf_stages_animation, by = c("year", "stage")) %>%
  mutate(rank = as.integer(rank)) %>%
  group_by(year, stage) %>%
  mutate(finishers = sum(!is.na(rank))) %>%
  ungroup() %>%
  mutate(percentile = 1 - rank / finishers)

total_points <- stages_joined %>%
  group_by(year, rider) %>%
  summarise(total_points = sum(points, na.rm = TRUE)) %>%
  mutate(point_rank = percent_rank(total_points)) %>%
  ungroup()

top_10_2019 <- total_points %>%
  filter(year == max(year)) %>%
  top_n(15, total_points)
```

```{r stage-point, fig.cap="The number of times the rider win the Tour de France"}
stages_joined %>%
  filter(year == max(year)) %>%
  semi_join(top_10_2019, by = "rider") %>%
  mutate(stage = as.integer(stage),
         points = coalesce(points, 0)) %>%
  arrange(stage) %>%
  group_by(rider) %>%
  mutate(cumulatice_points = cumsum(points)) %>%
  ungroup() %>%
  mutate(highlight = ifelse(rider == "Bernal Egan", T, F)) %>%
  ggplot(aes(cumulatice_points, rider, fill = highlight)) +
  geom_col() +
  ylab("Riders") +
  xlab("Cumulative Points") +
  theme_classic() +
  theme(legend.position = "none") +
  scale_fill_manual(values=c('#839192', '#EC7063')) +
  transition_time(stage) 
```


The animation (Figure \@ref(fig:stage-point)) displays the changes in the cumulative points of riders in 2019 (the higher rank, the higher points). It only shows the top 15 drivers with accumulated points. The red bar is the winner of 2019, Bernal Egan. It is not difficult to find that the winner does not need to achieve outstanding results at every stage. Compared with the riders who got higher cumulative points, the winners’ cumulative points are only half of theirs. 

These figures give us a more in-depth exploration of data guidance. What are the characteristics of Tour de France winner riders? How does the distance and speed of the Tour de France change? Is the Tour de France becoming more competitive?

## What are the characteristics of those winner riders?

For sports, the physical fitness of an athlete is the core factor that affects the outcome of the game. Especially for races like the Tour de France, the 23-day race is a severe test for athletes' physical fitness.

BMI is usually a significant indicator for determining a person's physical health. For example, a low BMI implies that the person will suffer and experienced weakened immune systems or weakened bones. We combine the height and weight variables of athletes into BMI according to the following formula:


<center>
$BMI = \frac{Weight(kg)}{(Height(m))^2}$
</center>



```{r bmi-year, fig.cap="BMI of previous Tour de France winners"}

editions %>%
  ggplot(aes(x = start_date, y = weight / height^2)) +
  geom_point(na.rm = TRUE) + 
  geom_hline(yintercept = c(19, 25), color = "red", linetype = "dashed") +
  geom_label_repel(data = editions %>% sample_n(20), 
                  aes(label = winner_name), size = 1.8,  
                  nudge_y = 4, na.rm = TRUE,
                  segment.alpha = 0.2) + 
  xlab('Edition date') + 
  ylab('Body mass index (BMI)') + 
  ggtitle('Tour de France winners BMI') + 
  theme_classic() 
```

Figure \@ref(fig:bmi-year) shows the BMI value of the winners of the Tour de France each year. We can observe that the BMI of the winners mostly concentrated in a particular range. The red dash line is representing the range of appropriate BMI for adult males, which is between 19 and 25. In recent years, the BMI of the winners of the Tour de France has a certain downward trend, but this trend is not very obvious.

```{r age-dist, fig.width=10, fig.cap="The age of the previous winners of the Tour de France"}
library(gridExtra)
age_line <- winners %>%
  group_by(decade = 10 * (year(start_date) %/% 10)) %>%
  summarise(age = mean(age, na.rm = TRUE)) %>%
  ggplot(aes(x = decade, y = age)) +
  geom_line(colour="steelblue") +
  ylab("Average Age") +
  xlab("Year") +
  ggtitle('Tour de France winers average age (per decade)') + 
  theme_classic() 

age_histogram <- winners %>%
  ggplot(aes(x = age)) +
  geom_histogram(binwidth = 2, colour="steelblue", fill="steelblue", alpha=0.2) +
  geom_vline(xintercept = mean(winners$age, na.rm = TRUE), color = "red", linetype = "dashed") +
  ylab("Count") +
  xlab("Winners' Age")+
  ggtitle('Tour de France winners age distribution') + 
  theme_classic() 

grid.arrange(age_line, age_histogram, ncol = 2)
```

Age often plays a big factor in the assessment of potential athlete performance. The plots are present in Figure \@ref(fig:age-dist). The left panel displays the trend of the average age of the winners (average over a decade). We can see that although the average age has a high volatile over the hundred years if we focus on the trend after 1980 the average age of the winners has gradually increased, and the average age of those winners has achieved 29 in the past ten years. The right panel shows the age distribution of all winners. We can roughly see that the age distribution of the winners is mainly between 20 and 35 years old, and the average is about 27 years old. Compared to other competitions, the winners of the Tour de France are relatively older.

```{r winner-country, fig.cap="The number of times the Tour de France country has won"}
winners %>%
  count(nationality, sort = TRUE) %>%
  ggplot(aes(reorder(nationality, n), n)) +
  geom_col(width = 0.8,
           alpha = 0.8,
           color = "#E59866",
           fill = "#E59866") +
  labs(x = NULL, y = 'Tour de France wins') +
  geom_text(aes(label = n, y = n + 1)) +
  ggtitle("The number of times the Tour de France country has won") +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        panel.background = element_blank()) +
  coord_flip()
```

```{r winner-team, fig.cap="The number of times the Tour de France team has won"}
winners %>%
  count(winner_team, name = 'num_of_wins') %>%
  filter(num_of_wins > 1) %>%
  ggplot(aes(reorder(winner_team, num_of_wins), num_of_wins)) +
  geom_col(width = 0.8,
           alpha = 0.7,
           color = "#3498DB",
           fill = "#3498DB") +
  labs(x = NULL, y = 'Tour de France wins') +
  geom_text(aes(label = num_of_wins, y = num_of_wins + 0.5)) +
  ggtitle("The number of times the Tour de France team has won") +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        panel.background = element_blank()) +
  coord_flip()
```

If we compare the number of winners between countries (Refer to Figure \@ref(fig:winner-country)), the number of France far exceeds the number of second-place Belgium. Figure \@ref(fig:winner-team) compares the number of winners between the teams. The French team has four more winners than Alcyon-Dunlop, which is ranked second. 

It is not difficult to observe that both the number of winners between countries and teams, the number of ranked first are much higher than the following. This is because the Tour de France also focuses on the strategy of the competition. A good team or country has a better strategy that is more suitable for competition. Specifically, the financial backing of these larger teams allow them to attract top tier riders, coaches and staff given the pay packets they are able to provide as well as being able to afford all the state of the art practices that assist performance thus potentially improving their dominance relative to smaller teams (@LindseyJ). This may indicate that a rider may have a better chance of winning the Tour de France depending on the team they have chosen.


##  How does the distance and speed of the Tour de France change?

<br>

**The distance covered in Tour de France through the history**

It is worthwhile for the next Tour de France contenders to observe how the distance has changed ever since the competition held for the first time in 1903 to get more understanding of the battlefield. The previous report by Ang and Lyubic, which calculated the percentage of the riders who failed to complete each stage, has given us a hint that the most significant difficulty lied in the mountain and hilly stages. Figure \@ref(fig:DNF-OTL-NQ) conveys that 2.13% of all riders that have entered the mountain stage have failed to complete it, whilst 1.61% of all riders that have entered the hilly stage have failed to complete it. 

```{r combining-stage-clean-tdf-stage-data}
#code used to create the datasets for finding the terrains that aren't being completed as well as the overall winner

stage_clean_stg_number <- stage_clean %>%
  filter(year >= "1969") %>%
  group_by(stage_results_id) %>%
  separate(stage_results_id, c("stage", "stage_number"), "-") %>%
  mutate(year_stage = paste0(year, "-", stage_number)) 

tdf_stage_stg_number <- tdf_stages %>%
  mutate(year = year(Date),
         year_stage = paste0(year, "-", Stage)) %>%
  filter(year >= "1969") %>%
  select(Stage, Date, Type, year, year_stage, Distance) %>%
  janitor::clean_names() 

tdf_stage_clean <-  tdf_stage_stg_number %>%
  left_join(stage_clean_stg_number, by = "year_stage") %>%
  select(stage_number, rank, rider, elapsed, year.x, distance, type, date) %>%
  rename(year = year.x)

tdf_stages_names_clean <- tdf_stage_clean %>%
  mutate(
    Type_terrain = case_when(
      str_detect(type, "mountain|Mountain|mountain(s)") ~ "Mountain",
      str_detect(type, "Flat|Plain") ~ "Flat",
      str_detect(type, "Individual time trial|Mountain time trial") ~ "Time Trial",
      str_detect(type, "Hilly") ~ "Hilly Stage"))
```



```{r finding-pct-rider-DNF}
#Table showing the percentage of DNF OTL NQ by terrain
terrain_DNF_OTL_NQ <- tdf_stages_names_clean %>%
  filter(rank %in% c("DNF", "OTL", "NQ")) %>%
  group_by(Type_terrain) %>%
  summarise(not_finished = n()) %>%
  arrange(not_finished) %>%
  mutate(not_finished = as.numeric(not_finished))
  
total_riders_stage <- tdf_stages_names_clean %>%
  group_by(Type_terrain) %>%
  summarise(total_riders = n())

total_riders_dnf_terrain <- left_join(terrain_DNF_OTL_NQ, total_riders_stage, by = "Type_terrain") %>%
  filter(Type_terrain %in% c("Time Trial", "Flat", "Mountain", "Hilly Stage"))  %>% 
  mutate(pct_not_finish = (not_finished/total_riders)*100)
```


```{r DNF-OTL-NQ, out.width="50%", fig.cap = "The percentage of riders that have not finished the main for stages, since 1969"}
total_riders_dnf_terrain %>%
  ggplot(aes(x = fct_reorder(Type_terrain, -pct_not_finish),
             y = pct_not_finish)) +
  geom_col(stat = "identity", fill = "tomato") +
  ggtitle("Percentage of riders that failed to finish in each stage") +
  xlab("Stage Type") +
  ylab("Percentage of Riders") +
  theme_classic() 
```

We then used this information to categorize the distance by the percentage of the mountain and hilly stage. Based on the range of that percentage, we divided the distance into four types, namely 

1. The distance with less than 40% mountain and hill; 
2. The distance with 40% - 49.9% mountain and hill; 
3. The distance with 50% - 59.9% mountain and hill;
4. The distance with more than and equal to 60% mountain and hill.  

Further, we also add the trend line into the plot using the loess method. Our finding is reported in the following figure.


```{r dist-wrangling}

# The previous analysis only used the data from 1969. 
# In this analysis, we would not cut the period of the data
# We would use mostly the same code, but we remove the filter of year
# We also change the terrain type categorisation

stage_clean_stg_number_new <- stage_clean %>%
  group_by(stage_results_id) %>%
  separate(stage_results_id, c("stage", "stage_number"), "-") %>%
  mutate(year_stage = paste0(year, "-", stage_number)) 

tdf_stage_stg_number_new <- tdf_stages %>%
  mutate(year = year(Date),
         year_stage = paste0(year, "-", Stage)) %>%
  select(Stage, Date, Type, year, year_stage, Distance) %>%
  janitor::clean_names() 

tdf_stage_clean_new<-  tdf_stage_stg_number_new %>%
  left_join(stage_clean_stg_number, by = "year_stage") %>%
  select(stage_number, rank, rider, elapsed, year.x, distance, type, date) %>%
  rename(year = year.x)

tdf_stages_names_clean_new <- tdf_stage_clean_new %>%
  mutate(
    Type_terrain = case_when(
      str_detect(type, "mountain|Mountain|mountain(s)") ~ "Mountain",
      str_detect(type, "Flat|Plain") ~ "Flat",
      str_detect(type, "Individual time trial|Team time trial") ~ "Time Trial",
      str_detect(type, "Hilly") ~ "Hilly",
      str_detect(type, "Transition|Intermediate|Half") ~ "Transition"))


stage_type_group <- tdf_stages_names_clean_new %>%
  group_by(year, Type_terrain) %>%
  summarise(type_ave = mean(distance, na.rm = TRUE)) %>%
  pivot_wider(names_from = Type_terrain,
              values_from = type_ave) %>%
  replace_na(list(`Time Trial` = 0, Hilly = 0, Transition = 0)) %>% #replace the NA
  mutate(total_mount_hill = Mountain + Hilly,
         total_dist = Mountain + Flat + Hilly + Transition + `Time Trial`,
         perc_mount_hill = total_mount_hill/total_dist * 100)

perc_mount_hill <- stage_type_group %>%
  select(year, perc_mount_hill)
```


```{r dist-data}

winners <- winners %>% mutate(year = year(start_date))

dist_data <- left_join(winners, perc_mount_hill, by = "year") %>%
  mutate(perc_mount_hill_cat = ifelse(perc_mount_hill < 40, "< 40",
                                      ifelse(perc_mount_hill >= 40 & perc_mount_hill < 50 , "40 - 49.9",
                                             ifelse(perc_mount_hill >= 50 & perc_mount_hill < 60 , "50 - 59.9",
                                                    ">= 60")))) %>%
  mutate(perc_mount_hill_cat = factor(perc_mount_hill_cat, levels = c("< 40", "40 - 49.9", "50 - 59.9", ">= 60")))


```

```{r dist-plot, fig.cap = "The distance of Tour de France Route from 1903 to 2019"}
dist_plot <- ggplot(dist_data) +
  geom_point(aes(x = year,
             y = distance,
             colour = perc_mount_hill_cat)) +
  labs(x = "Year",
       y = "Distance (km)",
       title = "The distance of Tour de France Route through the history (1903-2019)",
       colour = "Percentage of mountain and hilly stage") +
  geom_smooth(aes(x = year, y = distance),
              method = "loess", se = FALSE, color = "steelblue", alpha = 0.5, size = 0.5) +
  scale_x_continuous(breaks=seq(1903, 2019, 10)) +
  theme_classic() +
  theme(legend.position = "bottom",
        text = element_text(size = 10),
        plot.title.position = "plot") 
  
ggMarginal(dist_plot, margins = 'y', size=4, type = "histogram", 
           fill = "steelblue", 
           color = "steelblue",
           alpha = 0.7)
```
In Figure \@ref(fig:dist-plot), we can see that until 1933, the distance covered on the Tour de France continued to increase. The reason might be because, at that time, this competition was intended to gain the popularity of L'Auto Sport Magazine. The long distance cycling was sensational and could gain the sell of this magazine [@origin]. Not surprisingly, in that period, the Tour de France distance can reach more than 5000 km. After 1933, the competition's mileage gradually declined.

If we look at the marginal histogram on the right side of the plot, we can also infer that the distribution of Tour de France distance is multimodal. In the first three decades of the competition, the most frequent distance is around 5500 km. After that, the most frequent distances decreased to about 4500 km and 4000 km. Finally, it went down again to around 3500 km.

Does this decreasing trend mean that the difficulty level of the Tour de France was also decreasing? Based on Figure \@ref(fig:dist-plot), we can learn that after 1933 to the late 1960s, when the trend decreased, the route was still dominated by 40-49.9 percent mountains, just like before 1933. It means that the terrain did not change that much, and therefore, the difficulty might have been reduced. 

In the early 1970s to 2006, as the distance decreased, the route was dominated by more challenging terrain, namely more than 50 percent of mountains and hills. Hence, the shorter distance did not make the competition was easier. We can say that 2007 to 2016 might be a more relaxed period because the trend declined and the percentage of mountains and hills were less than 50 percent of the total distance. In 2018 and 2019, the percentage of mountain and hill stages increased again to more than 60 percent of the total distance.

<br>

**The speed of the winners. How does the bicycle technology development and doping usage associate the performance?**

<br>


```{r speed-data}
dist_data <- dist_data %>% 
  mutate(speed = distance/time_overall,
         bicycle_tech = ifelse(year >= 1937 & year < 1972 , "derailleur introduced",
                               ifelse(year >= 1972 & year < 1985, "lighweight bike introduced",
                                      ifelse(year >= 1985 & year < 1990, "disc wheel introduced",
                                             ifelse(year >= 1990, "other technologies developed",
                                                    "pre-revolutionery tech")))),
         doping = ifelse(year >= 1990 & year < 2000, "doping is widespread, no test",
                         ifelse(year >= 2000 & year < 2008, "doping is tested",
                                ifelse(year >= 2008, "cyclist also monitored using blood passport",
                                       "pre-doping widespread")))) %>%
  mutate(bicycle_tech = factor(bicycle_tech, levels = c("pre-revolutionery tech", 
                                            "derailleur introduced", 
                                            "lighweight bike introduced", 
                                            "disc wheel introduced",
                                            "other technologies developed")))


```


```{r speed-plot, fig.height=6, fig.width=8, fig.cap = "Speed of the winners through the history (1903-2018)"}

cuts1 <- data.frame(Ref="Doping is widespread, no test", vals=c(1990))
cuts2 <- data.frame(Ref="Doping is tested", vals=c(2000))
cuts3 <- data.frame(Ref="Blood passport usage", vals=c(2008))
cuts <- rbind(cuts1, cuts2, cuts3)



speed_plot <- ggplot(filter(dist_data, !is.na(speed))) +
  geom_point(aes(x = year,
                 y = speed,
                 colour = bicycle_tech)) +
  geom_smooth(aes(x = year, y = speed),
              method = "loess", se = FALSE, color = "steelblue", alpha = 0.5, size = 0.5) +
  geom_vline(data = cuts , aes(xintercept=vals), colour = "tomato", alpha = 0.5, size = 0.5) +
  geom_text(mapping = aes(x = vals,
                          y = 0,
                          label = Ref,
                          hjust = 0,
                          vjust = -0.5,
                          angle = 90),
            data = cuts,
            size = 3) + 
  scale_x_continuous(breaks=seq(1900, 2020, 10)) +
  scale_y_continuous(breaks=seq(20, 50, 5))+
  theme_classic() +
  theme(text = element_text(size = 10),
        legend.position = "bottom") +
  labs(title = "Speed of the winners through the history (1903-2019)",
       subtitle = "Observing the association of speed with bicycle technology and doping usage",
       x = "Year",
       y = "Speed (km/hour)",
       colour = "Bicycle technology") +
  guides(colour=guide_legend(nrow=2,byrow=TRUE))
  

ggMarginal(speed_plot, margins = 'y', size=4, type = "density", 
           fill = "steelblue", 
           color = "steelblue", 
           alpha = 0.4 )

```


In contrast to distance, cyclist speed has increased throughout the history of the Tour de France (refer to Figure \@ref(fig:speed-plot)). We tried to examine the existence of the lurking variables behind this phenomenon. According to @petrocik, one of the reasons for cyclists' increasing speed is because bicycle technology continues to develop. Therefore, we tried to divide the competition period based on the time line of bicycle technology development, which we refer from @homfray. We also mark the period when doping became widespread, and the testing was used, since according to @rivenaes, doping usage also impacted cyclist speed.

The density plot in Figure \@ref(fig:speed-plot) shows that the riders' speed has a bimodal distribution. Referring to the development of bicycle technology, the shorter peak could be associated with the period before the bicycle's revolutionary technology was achieved. At that time, the average speed of a cyclist was only about 25 km/hour. After derailleur was discovered in 1938, there was an increase in cyclist speed. It is because cyclists can change the gear to travel through mountains using this tool. However, the invention of lightweight bicycles in early 1970s and disc wheels in 1985 did not seems to be associated with the increased of cyclists' speed. It can be seen from the speed that tends to be flat. 

In 1990 and later, bicycle technology continued to develop. From now on, doping is also illegally used by cyclists to increase their stamina.  Further, the highest speed in history happened in 1998, right in this era of doping use. The fastest record was created by Lance Armstrong, who finally admitted that he had also used doping to win the competition. Starting in 2000, when doping use was tested, there was no noticeable change in cyclist speed. We can see that the speed tends to be the same as in the previous period. Only when blood passports were used in 2008, riders' speed was slower because it tested doping more closely.

<br>

## Is the Tour de France becoming more competitive?

With the increase in the number of holding of the Tour de France and the development of technology, the equipment becomes more advanced, and the team's strategy becomes more mature, which may lead to more intense competition in the competition. In the following, we will analyse whether the Tour de France has become more competitive based on the data.

```{r, fig.cap="Average hours taken by the winner to complete the race"}
winner_hours <- winners %>%
  group_by(decade = 10 * (year(start_date) %/% 10)) %>%
  summarise(time_overall = mean(time_overall, na.rm = TRUE)) %>%
  ggplot() +
  geom_line(aes(x = decade, y = time_overall), colour="steelblue") +
  ylab("Average Hours") +
  xlab("Year") +
  ggtitle('Tour de France winers average finish time (per decade)') + 
  theme_classic() 

ggplotly(winner_hours)
```

As showing in Figure 5, the average of total hours taken by the winner to complete the race are increased before 1920 and reached its peak around 1920, which is over two hundred hours. After 1920, the average total hours began to decline, and until the past decades, the average total hours have dropped to less than ninety hours. However, this result is still not enough to support that the riders are getting faster than before and the competition getting more competitive, because the reduction in average total hours is also affected by the distance of the races.

```{r, fig.cap="Average difference in finishing time between the race winner and the runner up"}
winner_time_margin <- winners %>%
  group_by(decade = 10 * (year(start_date) %/% 10)) %>%
  summarise(time_margin = mean(time_margin, na.rm = TRUE)) %>%
  ggplot() +
  geom_line(aes(x = decade, y = time_margin * 60), colour="steelblue") +
  ylab("Average time difference (min)") +
  xlab("Year") +
  ggtitle('Tour de France winers average time margin (per decade)') + 
  theme_classic() 

ggplotly(winner_time_margin)
```

Then, we can look at the time margin trend (Refer to Figure 6); the line represents the trend of time margin over decades. From the figure, it is obvious that the time margin is decreasing, which means that the time gap between the winner and the second place is getting smaller. By 2010, the time margin was already less than three minutes. This means that regardless of the length of the distance, the performance difference between the riders has become smaller, and the competition has become more intense. A slight mistake may lose the chance of winning.


# Conclusion

Through the above analysis, we can conclude that the winners do not have to perform outstandingly in most of the stages, they need to retain physical strength in some stages, and allocate it to other stages reasonably. The common characters of the winners are that the BMI is within a reasonable range for male, and their ages are around 27 because older riders are more experienced in the competition. Moreover, France is more likely to win because of its natural geographical conditions and excellent resources.

The analysis also shows that the Tour de France's distance has decreased considerably compared to its initial period. Taking the terrain difficulty level into account, we can conclude that decreasing the distance does not necessarily decrease the difficulty level of the Tour De France because the mountain and hilly stages was dominating from early of 1970s to 2006. 

In contrast with distance, cyclists are getting faster from time to time. We found that the derailleur discovery was associated with the increasing of cyclists' speed. Further, after 1990, cyclists' speed continued to increase. It can be associated with drug use by the athletes. Their speed seemed to decrease slightly when the doping test was carried out more strictly using a blood passport.

As the time difference between the riders getting narrower, the competition is becoming more competitive, and the strategy at each stage of the competition is particularly important. 

The limitation of this research is the dataset contains too many variables, there are a relatively low proportion of missing values, so there are many analysable questions that it is challenging to cover all the possible analysis in one report. In addition, we also could not observe all of the variables as the potential lurking variables, so we used only the hint from the previous report and some references from articles. 

# Acknowledgement

Thanks for _tidytuesday_ provided the data cleaning process, relevant articles and original data source on GitHub (@tidytuesday). The dataset used is Tour de France dataset offered by _Alastair Rushworth_ on the `tdf` package (@tdf). Thanks for _Samuel Lyubic_ and _Brendi Ang_ for provided an excellent report as our reference.  

Packages used are @GGPLOT, @Tidyverse, @plotly, @kableExtra, @lubridate, @naniar, @plotly, @ggExtra, @ggforce, @patchwork, @polite, @rvest, @ggrepel, @gifski, @png and @gganimate.


\clearpage

# References

