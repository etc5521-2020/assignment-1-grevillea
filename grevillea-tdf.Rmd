---
title: "Tour de France"
author: "Samuel Lyubic xxxxx"
date: "18/08/2020"
output: 
  bookdown::html_document2:
    theme: cosmo
---

```{r setup-libraries, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.align = "center", fig.height = 8, fig.width = 8)

library(tidyverse)
library(readr)
library(kableExtra)
library(bookdown)
library(lubridate)
library(tdf) #add the devtool install link for reproducibility
library(tidyr)
library(here)
library(gridExtra)
```

```{r read-in-data}
tdf_winners <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-04-07/tdf_winners.csv')

devtools::install_github("thebioengineer/tidytuesdayR")
tuesdata <- tidytuesdayR::tt_load('2020-04-07')
```

```{r data--cleaning}
winners <- tdf::editions %>% 
  select(-stage_results)

all_years <- tdf::editions %>% 
  unnest_longer(stage_results) %>% 
  mutate(stage_results = map(stage_results, ~ mutate(.x, rank = as.character(rank)))) %>% 
  unnest_longer(stage_results)

stage_all <- all_years %>% 
  select(stage_results) %>% 
  flatten_df()

combo_df <- bind_cols(all_years, stage_all) %>% 
  select(-stage_results)

stage_clean <- combo_df %>% 
  select(edition, start_date,stage_results_id:last_col()) %>% 
  mutate(year = lubridate::year(start_date)) %>% 
  rename(age = age...25) %>% 
  select(edition, year, everything(), -start_date)

winners %>% 
  write_csv(here::here("tdf_winners.csv"))

stage_clean %>% 
  write_csv(here::here("stage_data.csv"))
```

```{r read-in-csv}
stage_clean <- read_csv(here::here("stage_data.csv"))
tdf_winners <- read_csv(here::here("tdf_winners.csv"))
```

```{r structure-of-dataset}
str(stage_clean)
str(tdf_winners)
```

```{r height-vs-weight, fig.width = 12}
win_weight <- winners %>%
  ggplot(aes(x = as.factor(edition),
             y = weight)) +
  geom_point() +
  geom_line() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
win_weight

winners %>%
  ggplot(aes(x = weight)) +
  geom_histogram()
```

```{r vital-team}
team_wins <- winners %>%
  group_by(winner_team) %>%
  summarise(n = n()) 

team_wins %>%
  ggplot(aes(x = fct_reorder(as.factor(winner_team), n, .desc = TRUE),
             y = n)) +
    geom_col() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

```

```{r winner-nationality}
winners_nationality <- winners %>%
  group_by(nationality) %>%
  summarise(n = n())

winners_nationality %>%
  ggplot(aes(x = fct_reorder(as.factor(nationality), n, .desc = FALSE),
             y = n)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

```{r distance-v-age}
distance_winner <- winners %>%
  ggplot(aes(x = start_date, 
             y = distance)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

age_winner <- winners %>%
  ggplot(aes(x = start_date,
                 y = age)) + 
  geom_point(point = "blue") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

grid.arrange(distance_winner, age_winner, win_weight, ncol = 3)
```

```{r bmi}
winners %>%
ggplot(aes(x = start_date, y = weight / height^2, 
             color = edition)) +
  geom_point(na.rm = TRUE)
```

```{r stages-led-win-age}
stages_led_winner <- winners %>%
  ggplot(aes(x = start_date,
             y = stages_led,
             color = edition)) +
  geom_point()

stage_win_winner <- winners %>%
  ggplot(aes(x = start_date,
             y = stage_wins,
             color = edition)) +
  geom_point()

stage_wins_age <- winners %>%
  ggplot(aes(x = age,
             y = stage_wins,
             color = edition)) +
  geom_point()

```

```{r age-team}
age_team <- winners %>%
  ggplot(aes(x = winner_team,
              y = age)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
age_team

country_team <- winners %>%
  ggplot(aes(x = winner_team,
              y = nationality)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```
